!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Mars=e()}}(function(){var e;return function t(e,n,r){function o(u,a){if(!n[u]){if(!e[u]){var s="function"==typeof require&&require;if(!a&&s)return s(u,!0);if(i)return i(u,!0);var f=new Error("Cannot find module '"+u+"'");throw f.code="MODULE_NOT_FOUND",f}var c=n[u]={exports:{}};e[u][0].call(c.exports,function(t){var n=e[u][1][t];return o(n?n:t)},c,c.exports,t,e,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0});var f=e("eventemitter3"),c=r(f),l=function(e){function t(){return o(this,t),i(this,Object.getPrototypeOf(t).apply(this,arguments))}return u(t,e),s(t,[{key:"emitAsync",value:function(e,t,n,r,o,i){var u=c["default"].prefixed,a=u?u+e:e;if(!this._events||!this._events[a])return Promise.resolve();var s=void 0,f=this._events[a],l=arguments.length,d=void 0;if("function"==typeof f.fn){switch(f.once&&this.removeListener(e,f.fn,void 0,!0),l){case 1:return Promise.resolve(f.fn.call(f.context));case 2:return Promise.resolve(f.fn.call(f.context,t));case 3:return Promise.resolve(f.fn.call(f.context,t,n));case 4:return Promise.resolve(f.fn.call(f.context,t,n,r));case 5:return Promise.resolve(f.fn.call(f.context,t,n,r,o));case 6:return Promise.resolve(f.fn.call(f.context,t,n,r,o,i))}for(s=1,d=new Array(l-1);l>s;s++)d[s-1]=arguments[s];return Promise.resolve(f.fn.apply(f.context,d))}var h=[],p=f.length,y=void 0;for(s=0;p>s;s++)switch(f[s].once&&this.removeListener(e,f[s].fn,void 0,!0),l){case 1:h.push(Promise.resolve(f[s].fn.call(f[s].context)));break;case 2:h.push(Promise.resolve(f[s].fn.call(f[s].context,t)));break;case 3:h.push(Promise.resolve(f[s].fn.call(f[s].context,t,n)));break;default:if(!d)for(y=1,d=new Array(l-1);l>y;y++)d[y-1]=arguments[y];h.push(Promise.resolve(f[s].fn.apply(f[s].context,d)))}return Promise.all(h)}}]),t}(c["default"]);n["default"]=l},{eventemitter3:34}],2:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0});var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u={};!function(){for(var e=0;e<i.length;e++)u[i.charAt(e)]=e}();var a=function(e){return i.charAt(e)},s=function(e){return"="===e?-1:u[e]},f=n.Base64=function(){function e(){r(this,e)}return o(e,[{key:"encode",value:function(e){if("string"==typeof e){var t=e;e=this.newBinary(t.length);for(var n=0;n<t.length;n++){var r=t.charCodeAt(n);if(r>255)throw new Error("Not ascii. Base64.encode can only take ascii strings.");e[n]=r}}for(var o=[],i=null,u=null,s=null,f=null,n=0;n<e.length;n++)switch(n%3){case 0:i=e[n]>>2&63,u=(3&e[n])<<4;break;case 1:u|=e[n]>>4&15,s=(15&e[n])<<2;break;case 2:s|=e[n]>>6&3,f=63&e[n],o.push(a(i)),o.push(a(u)),o.push(a(s)),o.push(a(f)),i=null,u=null,s=null,f=null}return null!=i&&(o.push(a(i)),o.push(a(u)),null==s?o.push("="):o.push(a(s)),null==f&&o.push("=")),o.join("")}},{key:"decode",value:function(e){var t=Math.floor(3*e.length/4);"="==e.charAt(e.length-1)&&(t--,"="==e.charAt(e.length-2)&&t--);for(var n=this.newBinary(t),r=null,o=null,i=null,u=0,a=0;a<e.length;a++){var f=e.charAt(a),c=s(f);switch(a%4){case 0:if(0>c)throw new Error("invalid base64 string");r=c<<2;break;case 1:if(0>c)throw new Error("invalid base64 string");r|=c>>4,n[u++]=r,o=(15&c)<<4;break;case 2:c>=0&&(o|=c>>2,n[u++]=o,i=(3&c)<<6);break;case 3:c>=0&&(n[u++]=i|c)}}return n}},{key:"newBinary",value:function(e){if("undefined"==typeof Uint8Array||"undefined"==typeof ArrayBuffer){for(var t=[],n=0;e>n;n++)t.push(0);return t.$Uint8ArrayPolyfill=!0,t}return new Uint8Array(new ArrayBuffer(e))}}]),e}();n["default"]=new f},{}],3:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":f(t))&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":f(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(){var e=arguments.length<=0||void 0===arguments[0]?0:arguments[0];J+=1,R=[],D=!1;var t=J;setTimeout(function(){t===J&&(D=!0,(0,p["default"])(R,function(e){return e()}),R=[])},e)}function s(){D&&console.warn("You are trying to change some default of the Collection,but all collections is already initialized. It may be happened because you are trying to configure Collection not at first execution cycle of main script. Please consider to move all configuration to first execution cycle.")}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.Collection=void 0,n._resetStartup=a,n._warnIfAlreadyStarted=s;var l=e("fast.js/map"),d=r(l),h=e("fast.js/forEach"),p=r(h),y=e("check-types"),v=r(y),m=e("./AsyncEventEmitter"),g=r(m),b=e("./IndexManager"),_=r(b),j=e("./StorageManager"),w=r(j),O=e("./CollectionDelegate"),E=r(O),S=e("./CursorObservable"),P=r(S),k=e("./ShortIdGenerator"),x=r(k),M=e("./EJSON"),A=r(M),I=P["default"],C=E["default"],$=w["default"],N=_["default"],T=x["default"],D=!1,R=[],J=0;a();var q=n.Collection=function(e){function t(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];o(this,t);var r=i(this,Object.getPrototypeOf(t).call(this));return r.options=n,r._modelName=e,n.inMemory&&(n.cursorClass=n.cursorClass||P["default"],n.delegate=n.delegate||E["default"],n.storageManager=n.storageManager||w["default"],n.indexManager=n.indexManager||_["default"],n.idGenerator=n.idGenerator||x["default"]),t.startup(function(){return r._lazyInitCollection()}),r}return u(t,e),c(t,[{key:"create",value:function(e){return v["default"].string(e)?A["default"].parse(e):e}},{key:"insert",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];this._lazyInitCollection();var r=this.idGenerator(this.modelName);return e=this.create(e),e._id=e._id||r.value,this.emit("beforeInsert",e,r),n.quiet||this.emit("sync:insert",e,r),this.delegate.insert(e,n,r).then(function(n){return t.emit("insert",e,null,r),n})}},{key:"insertAll",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return Promise.all((0,d["default"])(e,function(e){return t.insert(e,n)}))}},{key:"remove",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._lazyInitCollection(),this.emit("beforeRemove",e,n),n.quiet||this.emit("sync:remove",e,n),this.delegate.remove(e,n).then(function(e){return(0,p["default"])(e,function(e){return t.emit("remove",null,e)}),e})}},{key:"update",value:function(e,t){var n=this,r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];return this._lazyInitCollection(),this.emit("beforeUpdate",e,t,r),r.quiet||this.emit("sync:update",e,t,r),this.delegate.update(e,t,r).then(function(e){return(0,p["default"])(e.updated,function(t,r){n.emit("update",t,e.original[r])}),e})}},{key:"find",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._lazyInitCollection(),this.delegate.find(e,t)}},{key:"findOne",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._lazyInitCollection(),this.delegate.findOne(e,t)}},{key:"count",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._lazyInitCollection(),this.delegate.count(e,t)}},{key:"ids",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._lazyInitCollection(),this.delegate.ids(e,t)}},{key:"_lazyInitCollection",value:function(){if(!this._initialized){this._initialized=!0;var e=this.options,t=e.storageManager||$,n=e.delegate||C,r=e.indexManager||N;this.idGenerator=e.idGenerator||T,this.cursorClass=e.cursorClass||I,this.indexManager=new r(this,e),this.storageManager=new t(this,e),this.delegate=new n(this,e)}}},{key:"modelName",get:function(){return this._modelName}},{key:"indexes",get:function(){return this._lazyInitCollection(),this.indexManager.indexes}},{key:"storage",get:function(){return this._lazyInitCollection(),this.storageManager}}],[{key:"defaultCursor",value:function(){return arguments.length>0?(s(),void(I=arguments[0])):I}},{key:"defaultStorageManager",value:function(){return arguments.length>0?(s(),void($=arguments[0])):$}},{key:"defaultIdGenerator",value:function(){return arguments.length>0?(s(),void(T=arguments[0])):T}},{key:"defaultDelegate",value:function(){return arguments.length>0?(s(),void(C=arguments[0])):C}},{key:"defaultIndexManager",value:function(){return arguments.length>0?(s(),void(N=arguments[0])):N}},{key:"startup",value:function(e){D?e():R.push(e)}}]),t}(g["default"]);n["default"]=q},{"./AsyncEventEmitter":1,"./CollectionDelegate":4,"./CursorObservable":7,"./EJSON":14,"./IndexManager":15,"./ShortIdGenerator":18,"./StorageManager":19,"check-types":32,"fast.js/forEach":42,"fast.js/map":49}],4:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.CollectionDelegate=void 0;var a=e("fast.js/map"),s=r(a),f=e("./DocumentModifier"),c=r(f),l=n.CollectionDelegate=function(){function e(t){i(this,e),this.db=t}return u(e,[{key:"insert",value:function(e){var t=this;arguments.length<=1||void 0===arguments[1]?{}:arguments[1],arguments[2];return this.db.indexManager.indexDocument(e).then(function(){return t.db.storageManager.persist(e._id,e).then(function(){return e._id})})}},{key:"remove",value:function(e,t){var n=this,r=t.sort,i=void 0===r?{_id:1}:r,u=t.multi,a=void 0===u?!1:u;return this.find(e,{noClone:!0}).sort(i).then(function(e){e.length>1&&!a&&(e=[e[0]]);var t=(0,s["default"])(e,function(e){return n.db.storageManager["delete"](e._id)}),r=(0,s["default"])(e,function(e){return n.db.indexManager.deindexDocument(e)});return Promise.all([].concat(o(t),o(r))).then(function(){return e})})}},{key:"update",value:function(e,t,n){var r=this,i=n.sort,u=void 0===i?{_id:1}:i,a=n.multi,f=void 0===a?!1:a,l=n.upsert,d=void 0===l?!1:l;return this.find(e,{noClone:!0}).sort(u).then(function(n){return n.length>1&&!f&&(n=[n[0]]),new c["default"](e).modify(n,t,{upsert:d})}).then(function(e){var t=e.original,n=e.updated,i=(0,s["default"])(n,function(e){return r.db.storageManager.persist(e._id,e)}),u=(0,s["default"])(n,function(e,n){return r.db.indexManager.reindexDocument(t[n],e)});return Promise.all([].concat(o(i),o(u))).then(function(){return{modified:n.length,original:t,updated:n}})})}},{key:"find",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=this.db.cursorClass;return new n(this.db,e,t)}},{key:"findOne",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this.find(e,t).aggregate(function(e){return e[0]}).limit(1)}},{key:"count",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t.noClone=!0,this.find(e,t).aggregate(function(e){return e.length})}},{key:"ids",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t.noClone=!0,this.find(e,t).map(function(e){return e._id})}}]),e}();n["default"]=l},{"./DocumentModifier":10,"fast.js/map":49}],5:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.CollectionIndex=void 0;var u=e("invariant"),a=r(u),s=n.CollectionIndex=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];o(this,e),(0,a["default"])(t.fieldName,'CollectionIndex(...): you must specify a "feildName" option'),(0,a["default"])(!Array.isArray(t.fieldName),"CollectionIndex(...): compound index is not supported yet"),this.fieldName=t.fieldName,this.unique=t.unique||!1,this.sparse=t.sparse||!1,this.reset()}return i(e,[{key:"reset",value:function(){}},{key:"insert",value:function(e){}},{key:"remove",value:function(e){}},{key:"update",value:function(e,t){}},{key:"getMatching",value:function(e){}},{key:"getBetweenBounds",value:function(e){}},{key:"getAll",value:function(e){}}]),e}();n["default"]=s},{invariant:56}],6:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s="function"==typeof Symbol&&"symbol"===a(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":a(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":a(e)},f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};Object.defineProperty(n,"__esModule",{value:!0}),n.Cursor=n.PIPELINE_PROCESSORS=void 0;var l=e("fast.js/forEach"),d=r(l),h=e("fast.js/object/assign"),p=r(h),y=e("fast.js/object/keys"),v=r(y),m=e("fast.js/map"),g=r(m),b=e("./AsyncEventEmitter"),_=r(b),j=e("invariant"),w=r(j),O=e("./DocumentRetriver"),E=r(O),S=e("./DocumentMatcher"),P=r(S),k=e("./DocumentSorter"),x=r(k),M=e("./DocumentProjector"),A=r(M),I=e("./EJSON"),C=r(I),$=0,N=n.PIPELINE_PROCESSORS=c({},e("./cursor-processors/filter"),e("./cursor-processors/sortFunc"),e("./cursor-processors/map"),e("./cursor-processors/aggregate"),e("./cursor-processors/reduce"),e("./cursor-processors/join"),e("./cursor-processors/joinEach"),e("./cursor-processors/joinAll"),e("./cursor-processors/joinObj"),e("./cursor-processors/ifNotEmpty")),T=function(e){function t(){return o(this,t),i(this,Object.getPrototypeOf(t).apply(this,arguments))}return u(t,e),t}(_["default"]);(0,d["default"])(N,function(e,t){T.prototype[t]=e.method});var D=function(e){function t(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];o(this,t);var u=i(this,Object.getPrototypeOf(t).call(this));return u.db=e,u.options=r,u._id=$++,u._query=n,u._pipeline=[],u._latestResult=null,u._childrenCursors={},u._parentCursors={},u._ensureMatcherSorter(),u}return u(t,e),f(t,[{key:"skip",value:function(e){return(0,w["default"])(e>=0||"undefined"==typeof e,"skip(...): skip must be a positive number"),this._skip=e,this}},{key:"limit",value:function(e){return(0,w["default"])(e>=0||"undefined"==typeof e,"limit(...): limit must be a positive number"),this._limit=e,this}},{key:"find",value:function(e){return this._query=e,this._ensureMatcherSorter(),this}},{key:"project",value:function(e){return e?this._projector=new A["default"](e):this._projector=null,this}},{key:"sort",value:function(e){return(0,w["default"])("object"===("undefined"==typeof e?"undefined":s(e))||"undefined"==typeof e||Array.isArray(e),"sort(...): argument must be an object"),this._sort=e,this._ensureMatcherSorter(),this}},{key:"exec",value:function(){var e=this;return this.emit("beforeExecute"),this._createCursorPromise(this._doExecute().then(function(t){return e._latestResult=t,t}))}},{key:"then",value:function(e,t){return this.exec().then(e,t)}},{key:"_addPipeline",value:function(e,t){(0,w["default"])(e&&N[e],"Unknown pipeline processor type %s",e);for(var n=arguments.length,r=Array(n>2?n-2:0),o=2;n>o;o++)r[o-2]=arguments[o];return this._pipeline.push({type:e,value:t,args:r||[]}),this}},{key:"_processPipeline",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?0:arguments[1],r=this._pipeline[n];return r?Promise.resolve(N[r.type].process(e,r,this)).then(function(e){return"___[STOP]___"===e?e:t._processPipeline(e,n+1)}):Promise.resolve(e)}},{key:"_doExecute",value:function(){var e=this;return this._matchObjects().then(function(t){var n=void 0;return n=e.options.noClone?t:e._projector?e._projector.project(t):(0,g["default"])(t,function(e){return C["default"].clone(e)}),e._processPipeline(n)})}},{key:"_matchObjects",value:function(){var e=this,t=this._limit&&!this._skip&&!this._sorter,n=t?{limit:this._limit}:{},r=function(t){return t&&e._matcher.documentMatches(t).result};return new E["default"](this.db).retriveForQeury(this._query,r,n).then(function(n){if(t)return n;if(e._sorter){var r=e._sorter.getComparator();n.sort(r)}var o=e._skip||0,i=e._limit||n.length;return n.slice(o,i+o)})}},{key:"_ensureMatcherSorter",value:function(){this._sorter=void 0,this._matcher=new P["default"](this._query||{}),(this._matcher.hasGeoQuery||this._sort)&&(this._sorter=new x["default"](this._sort||[],{matcher:this._matcher}))}},{key:"_trackChildCursorPromise",value:function(e){var t=this,n=e.cursor;this._childrenCursors[n._id]=n,n._parentCursors[this._id]=this,this.once("beforeExecute",function(){delete t._childrenCursors[n._id],delete n._parentCursors[t._id],0===(0,v["default"])(n._parentCursors).length&&n.emit("beforeExecute")})}},{key:"_createCursorPromise",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return(0,p["default"])({cursor:this,then:function(r,o){return t._createCursorPromise(e.then(r,o),n)}},n)}}]),t}(T);n.Cursor=D,n["default"]=D},{"./AsyncEventEmitter":1,"./DocumentMatcher":9,"./DocumentProjector":11,"./DocumentRetriver":12,"./DocumentSorter":13,"./EJSON":14,"./cursor-processors/aggregate":20,"./cursor-processors/filter":21,"./cursor-processors/ifNotEmpty":22,"./cursor-processors/join":23,"./cursor-processors/joinAll":24,"./cursor-processors/joinEach":25,"./cursor-processors/joinObj":26,"./cursor-processors/map":27,"./cursor-processors/reduce":28,"./cursor-processors/sortFunc":29,"fast.js/forEach":42,"fast.js/map":49,"fast.js/object/assign":50,"fast.js/object/keys":52,invariant:56}],7:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":a(t))&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=function M(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:M(o,t,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)};Object.defineProperty(n,"__esModule",{value:!0}),n.CursorObservable=void 0;var c=e("fast.js/function/bind"),l=r(c),d=e("check-types"),h=r(d),p=e("fast.js/object/values"),y=r(p),v=e("fast.js/map"),m=r(v),g=e("./Cursor"),b=r(g),_=e("./EJSON"),j=r(_),w=e("./PromiseQueue"),O=r(w),E=e("./debounce"),S=r(E),P=1e3/60,k=10,x=function(e){function t(e,n,r){o(this,t);var u=i(this,Object.getPrototypeOf(t).call(this,e,n,r));return u.maybeUpdate=(0,l["default"])(u.maybeUpdate,u),u._observers=0,u._updateQueue=new O["default"](1),u._propagateUpdate=(0,S["default"])((0,l["default"])(u._propagateUpdate,u),0,0),u._doUpdate=(0,S["default"])((0,l["default"])(u._doUpdate,u),P,k),u}return u(t,e),s(t,[{key:"batchSize",value:function(e){return this._doUpdate.updateBatchSize(e),this}},{key:"debounce",value:function(e){return this._doUpdate.updateWait(e),this}},{key:"observe",value:function(e){function t(){n&&(n=!1,r._observers-=1,r.removeListener("update",e),r.removeListener("stop",t),0===r._observers&&(r._latestIds=null,r._latestResult=null,r._updatePromise=null,r.emit("observeStopped"),r.db.removeListener("insert",r.maybeUpdate),r.db.removeListener("update",r.maybeUpdate),r.db.removeListener("remove",r.maybeUpdate)))}arguments.length<=1||void 0===arguments[1]?{}:arguments[1];e=e||function(){},this._observers<=0&&(this.db.on("insert",this.maybeUpdate),this.db.on("update",this.maybeUpdate),this.db.on("remove",this.maybeUpdate));var n=!0,r=this;this._observers+=1,this.on("update",e),this.on("stop",t),this._updatePromise?null!==this._latestResult&&e(this._latestResult):this.update(!0,!0);var o={stop:t};return this._createCursorPromise(this._updatePromise,o)}},{key:"stopObservers",value:function(){return this._doUpdate.cancel(),this.emit("stop"),this}},{key:"update",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(!n){if(this._updateDebPromise&&!this._updateDebPromise.debouncePassed)return this._doUpdate(t),this._updatePromise;if(!(!this._updateDebAdded||this._updateDebPromise&&this._updateDebPromise.debouncePassed))return this._updatePromise;this._updateDebAdded=!0}return this._updatePromise=this._updateQueue.add(function(){return n?e._doUpdate.func(t):(e._updateDebAdded=!0,e._updateDebPromise=e._doUpdate(t),e._updateDebPromise.then(function(){e._updateDebAdded=!1,e._updateDebPromise=null}))}),this._updatePromise}},{key:"maybeUpdate",value:function(e,t){var n=null===e&&null===t,r=n||!e&&t&&(!this._latestIds||this._latestIds.has(t._id)),o=r||e&&t&&(this._matcher.documentMatches(e).result||this._matcher.documentMatches(t).result)&&!j["default"].equals(e,t),i=o||e&&!t&&this._matcher.documentMatches(e).result;return i?this.update():void 0}},{key:"_propagateUpdate",value:function(){var e=arguments.length<=0||void 0===arguments[0]?!1:arguments[0],t=this.emitAsync("update",this._latestResult,e),n=void 0;return e||(n=Promise.all((0,y["default"])((0,m["default"])(this._parentCursors,function(e,t){return e._propagateUpdate?e._propagateUpdate(!1):void 0})))),t.then(function(){return n})}},{key:"_doUpdate",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?!1:arguments[0];return t||this.emit("cursorChanged"),this.exec().then(function(n){return e._updateLatestIds(),e._propagateUpdate(t).then(function(){return n})})}},{key:"_updateLatestIds",value:function(){var e=h["default"].array(this._latestResult)?(0,m["default"])(this._latestResult,function(e){return e._id}):this._latestResult&&[this._latestResult._id];this._latestIds=new Set(e)}},{key:"_trackChildCursorPromise",value:function(e){f(Object.getPrototypeOf(t.prototype),"_trackChildCursorPromise",this).call(this,e),e.stop&&(this.once("cursorChanged",e.stop),this.once("observeStopped",e.stop),this.once("beforeExecute",e.stop))}}],[{key:"defaultDebounce",value:function(){return arguments.length>0?void(P=arguments[0]):P}},{key:"defaultBatchSize",value:function(){return arguments.length>0?void(k=arguments[0]):k}}]),t}(b["default"]);n.CursorObservable=x,n["default"]=x},{"./Cursor":6,"./EJSON":14,"./PromiseQueue":16,"./debounce":30,"check-types":32,"fast.js/function/bind":45,"fast.js/map":49,"fast.js/object/values":54}],8:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){return d["default"].string(e)||d["default"].number(e)}function i(e){return o(e)||e&&d["default"].object(e)&&e._id&&o(e._id)&&1===(0,v["default"])(e).length}function u(e){return d["default"].array(e)&&!g["default"].isBinary(e)}function a(e){return e&&3===b._type(e)}function s(e){return u(e)||a(e)}function f(e,t){if(!a(e))return!1;var n=void 0;return(0,p["default"])(e,function(r,o){var i="$"===o.substr(0,1);if(void 0===n)n=i;else if(n!==i){if(!t)throw new Error("Inconsistent operator: "+JSON.stringify(e));n=!1}}),!!n}function c(e){return/^[0-9]+$/.test(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.MongoTypeComp=void 0,n.selectorIsId=o,n.selectorIsIdPerhapsAsObject=i,n.isArray=u,n.isPlainObject=a,n.isIndexable=s,n.isOperatorObject=f,n.isNumericKey=c;var l=e("check-types"),d=r(l),h=e("fast.js/forEach"),p=r(h),y=e("fast.js/object/keys"),v=r(y),m=e("./EJSON"),g=r(m),b=n.MongoTypeComp={_type:function(e){return"number"==typeof e?1:"string"==typeof e?2:"boolean"==typeof e?8:u(e)?4:null===e?10:e instanceof RegExp?11:"function"==typeof e?13:e instanceof Date?9:g["default"].isBinary(e)?5:3},_equal:function(e,t){return g["default"].equals(e,t,{keyOrderSensitive:!0})},_typeorder:function(e){return[-1,1,2,3,4,5,-1,6,7,8,0,9,-1,100,2,100,1,8,1][e]},_cmp:function(e,t){if(void 0===e)return void 0===t?0:-1;if(void 0===t)return 1;var n=b._type(e),r=b._type(t),o=b._typeorder(n),i=b._typeorder(r);if(o!==i)return i>o?-1:1;if(n!==r)throw Error("Missing type coercion logic in _cmp");if(7===n&&(n=r=2,e=e.toHexString(),t=t.toHexString()),9===n&&(n=r=1,e=e.getTime(),t=t.getTime()),1===n)return e-t;if(2===r)return t>e?-1:e===t?0:1;if(3===n){var u=function(e){var t=[];for(var n in e)t.push(n),t.push(e[n]);return t};return b._cmp(u(e),u(t))}if(4===n)for(var a=0;;a++){if(a===e.length)return a===t.length?0:-1;if(a===t.length)return 1;var s=b._cmp(e[a],t[a]);if(0!==s)return s}if(5===n){if(e.length!==t.length)return e.length-t.length;for(a=0;a<e.length;a++){if(e[a]<t[a])return-1;if(e[a]>t[a])return 1}return 0}if(8===n)return e?t?0:1:t?-1:0;if(10===n)return 0;if(11===n)throw Error("Sorting not supported on regular expression");if(13===n)throw Error("Sorting not supported on Javascript code");throw Error("Unknown type to sort")}}},{"./EJSON":14,"check-types":32,"fast.js/forEach":42,"fast.js/object/keys":52}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return function(t){return t instanceof RegExp?String(t)===String(e):"string"!=typeof t?!1:(e.lastIndex=0,e.test(t))}}function u(e){if((0,A.isOperatorObject)(e))throw Error("Can't create equalityValueSelector for operator object");return null==e?function(e){return null==e}:function(t){return A.MongoTypeComp._equal(e,t)}}function a(e,t){t=t||{};var n,r=e.split("."),o=r.length?r[0]:"",i=(0,A.isNumericKey)(o),u=r.length>=2&&(0,A.isNumericKey)(r[1]);r.length>1&&(n=a(r.slice(1).join(".")));var s=function(e){return e.dontIterate||delete e.dontIterate,e.arrayIndices&&!e.arrayIndices.length&&delete e.arrayIndices,e};return function(e,r){if(r||(r=[]),(0,A.isArray)(e)){if(!(i&&o<e.length))return[];r=r.concat(+o,"x")}var a=e[o];if(!n)return[s({value:a,dontIterate:(0,A.isArray)(e)&&(0,A.isArray)(a),arrayIndices:r})];if(!(0,A.isIndexable)(a))return(0,A.isArray)(e)?[]:[s({value:void 0,arrayIndices:r})];var f=[],c=function(e){Array.prototype.push.apply(f,e)};return c(n(a,r)),!(0,A.isArray)(a)||u&&t.forSort||(0,y["default"])(a,function(e,t){(0,A.isPlainObject)(e)&&c(n(e,r.concat(t)))}),f}}function s(e,t){var n=[];return(0,y["default"])(e,function(e){var r=(0,A.isArray)(e.value);t&&r&&!e.dontIterate||n.push({value:e.value,arrayIndices:e.arrayIndices}),r&&!e.dontIterate&&(0,y["default"])(e.value,function(t,r){n.push({value:t,arrayIndices:(e.arrayIndices||[]).concat(r)})})}),n}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},c="function"==typeof Symbol&&"symbol"===f(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":f(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":f(e)},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),
r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.ELEMENT_OPERATORS=n.DocumentMatcher=void 0,n.regexpElementMatcher=i,n.equalityElementMatcher=u,n.makeLookupFunction=a,n.expandArraysInBranches=s;var d=e("check-types"),h=r(d),p=e("fast.js/forEach"),y=r(p),v=e("fast.js/object/keys"),m=r(v),g=e("fast.js/map"),b=r(g),_=e("fast.js/array/some"),j=r(_),w=e("fast.js/array/every"),O=r(w),E=e("fast.js/array/indexOf"),S=r(E),P=e("geojson-utils"),k=r(P),x=e("./EJSON"),M=r(x),A=e("./Document"),I=n.DocumentMatcher=function(){function e(t){o(this,e),this._paths={},this._hasGeoQuery=!1,this._hasWhere=!1,this._isSimple=!0,this._matchingDocument=void 0,this._selector=null,this._docMatcher=this._compileSelector(t)}return l(e,[{key:"documentMatches",value:function(e){if(!e||"object"!==("undefined"==typeof e?"undefined":c(e)))throw Error("documentMatches needs a document");return this._docMatcher(e)}},{key:"_compileSelector",value:function(e){if(e instanceof Function)return this._isSimple=!1,this._selector=e,this._recordPathUsed(""),function(t){return{result:!!e.call(t)}};if((0,A.selectorIsId)(e))return this._selector={_id:e},this._recordPathUsed("_id"),function(t){return{result:M["default"].equals(t._id,e)}};if(!e||"_id"in e&&!e._id)return this._isSimple=!1,F;if("boolean"==typeof e||(0,A.isArray)(e)||M["default"].isBinary(e))throw new Error("Invalid selector: "+e);return this._selector=M["default"].clone(e),C(e,this,{isRoot:!0})}},{key:"_recordPathUsed",value:function(e){this._paths[e]=!0}},{key:"_getPaths",value:function(){return h["default"].object(this._paths)?(0,m["default"])(this._paths):null}},{key:"hasGeoQuery",get:function(){return this._hasGeoQuery}},{key:"hasWhere",get:function(){return this._hasWhere}},{key:"isSimple",get:function(){return this._isSimple}}]),e}();n["default"]=I;var C=function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=[];return(0,y["default"])(e,function(e,o){if("$"===o.substr(0,1)){if(!R.hasOwnProperty(o))throw new Error("Unrecognized logical operator: "+o);t._isSimple=!1,r.push(R[o](e,t,n.inElemMatch))}else{n.inElemMatch||t._recordPathUsed(o);var i=a(o),u=$(e,t,n.isRoot);r.push(function(e){var t=i(e);return u(t)})}}),Q(r)},$=function(e,t,n){return e instanceof RegExp?(t._isSimple=!1,N(i(e))):(0,A.isOperatorObject)(e)?T(e,t,n):N(u(e))},N=function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return function(n){var r=n;t.dontExpandLeafArrays||(r=s(n,t.dontIncludeLeafArrays));var o={};return o.result=(0,j["default"])(r,function(t){var n=e(t.value);return"number"==typeof n&&(t.arrayIndices||(t.arrayIndices=[n]),n=!0),n&&t.arrayIndices&&(o.arrayIndices=t.arrayIndices),n}),o}},T=function(e,t,n){var r=[];return(0,y["default"])(e,function(o,i){var u=(0,S["default"])(["$lt","$lte","$gt","$gte"],i)>=0&&h["default"].number(o),a="$ne"===i&&!h["default"].object(o),s=(0,S["default"])(["$in","$nin"],i)>=0&&h["default"].array(o)&&!(0,j["default"])(o,h["default"].object);if("$eq"===i||u||s||a||(t._isSimple=!1),q.hasOwnProperty(i))r.push(q[i](o,e,t,n));else{if(!L.hasOwnProperty(i))throw new Error("Unrecognized operator: "+i);var f=L[i];r.push(N(f.compileElementSelector(o,e,t),f))}}),G(r)},D=function(e,t,n){if(!(0,A.isArray)(e)||h["default"].emptyArray(e))throw Error("$and/$or/$nor must be nonempty array");return(0,b["default"])(e,function(e){if(!(0,A.isPlainObject)(e))throw Error("$or/$and/$nor entries need to be full objects");return C(e,t,{inElemMatch:n})})},R={$and:function(e,t,n){var r=D(e,t,n);return Q(r)},$or:function(e,t,n){var r=D(e,t,n);return 1===r.length?r[0]:function(e){var t=(0,j["default"])(r,function(t){return t(e).result});return{result:t}}},$nor:function(e,t,n){var r=D(e,t,n);return function(e){var t=(0,O["default"])(r,function(t){return!t(e).result});return{result:t}}},$where:function(e,t){return t._recordPathUsed(""),t._hasWhere=!0,e instanceof Function||(e=Function("obj","return "+e)),function(t){return{result:e.call(t,t)}}},$comment:function(){return function(){return{result:!0}}}},J=function(e){return function(t){var n=e(t);return{result:!n.result}}},q={$not:function(e,t,n){return J($(e,n))},$ne:function(e){return J(N(u(e)))},$nin:function(e){return J(N(L.$in.compileElementSelector(e)))},$exists:function(e){var t=N(function(e){return void 0!==e});return e?t:J(t)},$options:function(e,t){if(!h["default"].object(t)||!t.hasOwnProperty("$regex"))throw Error("$options needs a $regex");return W},$maxDistance:function(e,t){if(!t.$near)throw Error("$maxDistance needs a $near");return W},$all:function(e,t,n){if(!(0,A.isArray)(e))throw Error("$all requires array");if(h["default"].emptyArray(e))return F;var r=[];return(0,y["default"])(e,function(e){if((0,A.isOperatorObject)(e))throw Error("no $ expressions in $all");r.push($(e,n))}),G(r)},$near:function(e,t,n,r){if(!r)throw Error("$near can't be inside another $ operator");n._hasGeoQuery=!0;var o,i,u;if((0,A.isPlainObject)(e)&&e.hasOwnProperty("$geometry"))o=e.$maxDistance,i=e.$geometry,u=function(e){return e&&e.type?"Point"===e.type?k["default"].pointDistance(i,e):k["default"].geometryWithinRadius(e,i,o)?0:o+1:null};else{if(o=t.$maxDistance,!(0,A.isArray)(e)&&!(0,A.isPlainObject)(e))throw Error("$near argument must be coordinate pair or GeoJSON");i=V(e),u=function(e){return(0,A.isArray)(e)||(0,A.isPlainObject)(e)?B(i,e):null}}return function(e){e=s(e);var t={result:!1};return(0,y["default"])(e,function(e){var n=u(e.value);null===n||n>o||void 0!==t.distance&&t.distance<=n||(t.result=!0,t.distance=n,e.arrayIndices?t.arrayIndices=e.arrayIndices:delete t.arrayIndices)}),t}}},B=function(e,t){e=V(e),t=V(t);var n=e[0]-t[0],r=e[1]-t[1];return h["default"].number(n)&&h["default"].number(r)?Math.sqrt(n*n+r*r):null},V=function(e){return(0,b["default"])(e,function(e){return e})},U=function(e){return{compileElementSelector:function(t){if((0,A.isArray)(t))return function(){return!1};void 0===t&&(t=null);var n=A.MongoTypeComp._type(t);return function(r){return void 0===r&&(r=null),A.MongoTypeComp._type(r)!==n?!1:e(A.MongoTypeComp._cmp(r,t))}}}},L=n.ELEMENT_OPERATORS={$lt:U(function(e){return 0>e}),$gt:U(function(e){return e>0}),$lte:U(function(e){return 0>=e}),$gte:U(function(e){return e>=0}),$mod:{compileElementSelector:function(e){if(!(0,A.isArray)(e)||2!==e.length||"number"!=typeof e[0]||"number"!=typeof e[1])throw Error("argument to $mod must be an array of two numbers");var t=e[0],n=e[1];return function(e){return"number"==typeof e&&e%t===n}}},$in:{compileElementSelector:function(e){if(!(0,A.isArray)(e))throw Error("$in needs an array");var t=[];return(0,y["default"])(e,function(e){if(e instanceof RegExp)t.push(i(e));else{if((0,A.isOperatorObject)(e))throw Error("cannot nest $ under $in");t.push(u(e))}}),function(e){return void 0===e&&(e=null),(0,j["default"])(t,function(t){return t(e)})}}},$size:{dontExpandLeafArrays:!0,compileElementSelector:function(e){if("string"==typeof e)e=0;else if("number"!=typeof e)throw Error("$size needs a number");return function(t){return(0,A.isArray)(t)&&t.length===e}}},$type:{dontIncludeLeafArrays:!0,compileElementSelector:function(e){if("number"!=typeof e)throw Error("$type needs a number");return function(t){return void 0!==t&&A.MongoTypeComp._type(t)===e}}},$regex:{compileElementSelector:function(e,t){if(!("string"==typeof e||e instanceof RegExp))throw Error("$regex has to be a string or RegExp");var n;if(void 0!==t.$options){if(/[^gim]/.test(t.$options))throw new Error("Only the i, m, and g regexp options are supported");var r=e instanceof RegExp?e.source:e;n=new RegExp(r,t.$options)}else n=e instanceof RegExp?e:new RegExp(e);return i(n)}},$elemMatch:{dontExpandLeafArrays:!0,compileElementSelector:function(e,t,n){if(!(0,A.isPlainObject)(e))throw Error("$elemMatch need an object");var r,o;return(0,A.isOperatorObject)(e,!0)?(r=$(e,n),o=!1):(r=C(e,n,{inElemMatch:!0}),o=!0),function(e){if(!(0,A.isArray)(e))return!1;for(var t=0;t<e.length;++t){var n,i=e[t];if(o){if(!(0,A.isPlainObject)(i)&&!(0,A.isArray)(i))return!1;n=i}else n=[{value:i,dontIterate:!0}];if(r(n).result)return t}return!1}}}},F=function(e){return{result:!1}},W=function(e){return{result:!0}},z=function(e){return 0===e.length?W:1===e.length?e[0]:function(t){var n={};return n.result=(0,O["default"])(e,function(e){var r=e(t);return r.result&&void 0!==r.distance&&void 0===n.distance&&(n.distance=r.distance),r.result&&r.arrayIndices&&(n.arrayIndices=r.arrayIndices),r.result}),n.result||(delete n.distance,delete n.arrayIndices),n}},Q=z,G=z},{"./Document":8,"./EJSON":14,"check-types":32,"fast.js/array/every":35,"fast.js/array/indexOf":38,"fast.js/array/some":41,"fast.js/forEach":42,"fast.js/map":49,"fast.js/object/keys":52,"geojson-utils":55}],10:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u="function"==typeof Symbol&&"symbol"===i(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":i(e)},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.findModTarget=n.DocumentModifier=void 0;var s=e("check-types"),f=r(s),c=e("fast.js/object/assign"),l=r(c),d=e("fast.js/forEach"),h=r(d),p=e("fast.js/array/every"),y=r(p),v=e("./EJSON"),m=r(v),g=e("./Random"),b=r(g),_=e("./DocumentMatcher"),j=r(_),w=e("./DocumentSorter"),O=r(w),E=e("./Document"),S=n.DocumentModifier=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];o(this,e),this._query=t,this._matcher=new j["default"](t)}return a(e,[{key:"modify",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=[],i=[];if((0,h["default"])(e,function(e){var u=t._matcher.documentMatches(e);if(u.result){var a=(0,l["default"])({arrayIndices:u.arrayIndices},r),s=t._modifyDocument(e,n,a);i.push(s),o.push(e)}}),!i.length&&r.upsert){var u=P(this._query);u._id=u._id||b["default"]["default"]().id(17),u=this._modifyDocument(u,n,{isInsert:!0}),i.push(u),o.push(null)}return{updated:i,original:o}}},{key:"_modifyDocument",value:function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(!(0,E.isPlainObject)(t))throw new Error("Modifier must be an object");t=m["default"].clone(t);var r,o=(0,E.isOperatorObject)(t);if(o)r=m["default"].clone(e),(0,h["default"])(t,function(e,t){var o=M[t];if(n.isInsert&&"$setOnInsert"===t&&(o=M.$set),!o)throw new Error("Invalid modifier specified "+t);(0,h["default"])(e,function(e,i){if(""===i)throw new Error("An empty update path is not valid.");if("_id"===i&&!n.isInsert)throw new Error("Mod on _id not allowed for update.");var u=i.split(".");if(!(0,y["default"])(u,function(e){return e}))throw new Error("The update path '"+i+"' contains an empty field name, which is not allowed.");var a=k(r,u,{noCreate:x[t],forbidArray:"$rename"===t,arrayIndices:n.arrayIndices}),s=u.pop();o(a,s,e,i,r)})});else{if(!n.isInsert&&t._id&&!m["default"].equals(e._id,t._id))throw new Error("Cannot change the _id of a document");for(var i in t)if(/\./.test(i))throw new Error("When replacing document, field name may not contain '.'");r=t,r._id=e._id}return r}}]),e}();n["default"]=S;var P=function(e){var t={};return f["default"].object(e)||(e={_id:e}),(0,h["default"])(e,function(e,n){if("$"!==n.substr(0,1)&&!(0,E.isOperatorObject)(e,!0)){var r=n.split("."),o=k(t,r);o&&(o[r[r.length-1]]=e)}}),t},k=n.findModTarget=function(e,t,n){n=n||{};for(var r=!1,o=0;o<t.length;o++){var i=o===t.length-1,a=t[o],s=(0,E.isIndexable)(e);if(!s){if(n.noCreate)return;var f=new Error("cannot use the part '"+a+"' to traverse "+e);throw f.setPropertyError=!0,f}if(e instanceof Array){if(n.forbidArray)return null;if("$"===a){if(r)throw new Error("Too many positional (i.e. '$') elements");if(!n.arrayIndices||!n.arrayIndices.length)throw new Error("The positional operator did not find the match needed from the query");a=n.arrayIndices[0],r=!0}else{if(!(0,E.isNumericKey)(a)){if(n.noCreate)return;throw new Error("can't append to array using string field name ["+a+"]")}a=parseInt(a,10)}if(i&&(t[o]=a),n.noCreate&&a>=e.length)return;for(;e.length<a;)e.push(null);if(!i)if(e.length===a)e.push({});else if("object"!==u(e[a]))throw new Error("can't modify field '"+t[o+1]+"' of list value "+JSON.stringify(e[a]))}else{if(a.length&&"$"===a.substr(0,1))throw new Error("can't set field named "+a);if(!(a in e)){if(n.noCreate)return;i||(e[a]={})}}if(i)return e;e=e[a]}},x={$unset:!0,$pop:!0,$rename:!0,$pull:!0,$pullAll:!0},M={$inc:function(e,t,n){if("number"!=typeof n)throw new Error("Modifier $inc allowed for numbers only");if(t in e){if("number"!=typeof e[t])throw new Error("Cannot apply $inc modifier to non-number");e[t]+=n}else e[t]=n},$set:function(e,t,n){if(!f["default"].object(e)&&!f["default"].array(e)){var r=new Error("Cannot set property on non-object field");throw r.setPropertyError=!0,r}if(null===e){var r=new Error("Cannot set property on null");throw r.setPropertyError=!0,r}e[t]=n},$setOnInsert:function(e,t,n){},$unset:function(e,t,n){void 0!==e&&(e instanceof Array?t in e&&(e[t]=null):delete e[t])},$push:function(e,t,n){if(void 0===e[t]&&(e[t]=[]),!(e[t]instanceof Array))throw new Error("Cannot apply $push modifier to non-array");if(!n||!n.$each)return void e[t].push(n);var r=n.$each;if(!(r instanceof Array))throw new Error("$each must be an array");var o=void 0;if("$position"in n){if("number"!=typeof n.$position)throw new Error("$position must be a numeric value");if(n.$position<0)throw new Error("$position in $push must be zero or positive");o=n.$position}var i=void 0;if("$slice"in n){if("number"!=typeof n.$slice)throw new Error("$slice must be a numeric value");if(n.$slice>0)throw new Error("$slice in $push must be zero or negative");i=n.$slice}var u=void 0;if(n.$sort){if(void 0===i)throw new Error("$sort requires $slice to be present");u=new O["default"](n.$sort).getComparator();for(var a=0;a<r.length;a++)if(3!==E.MongoTypeComp._type(r[a]))throw new Error("$push like modifiers using $sort require all elements to be objects")}if(void 0===o)for(var s=0;s<r.length;s++)e[t].push(r[s]);else{for(var f=[o,0],s=0;s<r.length;s++)f.push(r[s]);Array.prototype.splice.apply(e[t],f)}u&&e[t].sort(u),void 0!==i&&(0===i?e[t]=[]:e[t]=e[t].slice(i))},$pushAll:function(e,t,n){if(!("object"===("undefined"==typeof n?"undefined":u(n))&&n instanceof Array))throw new Error("Modifier $pushAll/pullAll allowed for arrays only");var r=e[t];if(void 0===r)e[t]=n;else{if(!(r instanceof Array))throw new Error("Cannot apply $pushAll modifier to non-array");for(var o=0;o<n.length;o++)r.push(n[o])}},$addToSet:function(e,t,n){var r=!1;if("object"===("undefined"==typeof n?"undefined":u(n)))for(var o in n){"$each"===o&&(r=!0);break}var i=r?n.$each:[n],a=e[t];if(void 0===a)e[t]=i;else{if(!(a instanceof Array))throw new Error("Cannot apply $addToSet modifier to non-array");(0,h["default"])(i,function(e){for(var t=0;t<a.length;t++)if(E.MongoTypeComp._equal(e,a[t]))return;a.push(e)})}},$pop:function(e,t,n){if(void 0!==e){var r=e[t];if(void 0!==r){if(!(r instanceof Array))throw new Error("Cannot apply $pop modifier to non-array");"number"==typeof n&&0>n?r.splice(0,1):r.pop()}}},$pull:function(e,t,n){if(void 0!==e){var r=e[t];if(void 0!==r){if(!(r instanceof Array))throw new Error("Cannot apply $pull/pullAll modifier to non-array");var o=[];if(null==n||"object"!==("undefined"==typeof n?"undefined":u(n))||n instanceof Array)for(var i=0;i<r.length;i++)E.MongoTypeComp._equal(r[i],n)||o.push(r[i]);else for(var a=new j["default"](n),i=0;i<r.length;i++)a.documentMatches(r[i]).result||o.push(r[i]);e[t]=o}}},$pullAll:function(e,t,n){if(!("object"===("undefined"==typeof n?"undefined":u(n))&&n instanceof Array))throw new Error("Modifier $pushAll/pullAll allowed for arrays only");if(void 0!==e){var r=e[t];if(void 0!==r){if(!(r instanceof Array))throw new Error("Cannot apply $pull/pullAll modifier to non-array");for(var o=[],i=0;i<r.length;i++){for(var a=!1,s=0;s<n.length;s++)if(E.MongoTypeComp._equal(r[i],n[s])){a=!0;break}a||o.push(r[i])}e[t]=o}}},$rename:function(e,t,n,r,o){if(r===n)throw new Error("$rename source must differ from target");if(null===e)throw new Error("$rename source field invalid");if("string"!=typeof n)throw new Error("$rename target must be a string");if(void 0!==e){var i=e[t];delete e[t];var u=n.split("."),a=k(o,u,{forbidArray:!0});if(null===a)throw new Error("$rename target field invalid");var s=u.pop();a[s]=i}},$bit:function(e,t,n){throw new Error("$bit is not supported")}}},{"./Document":8,"./DocumentMatcher":9,"./DocumentSorter":13,"./EJSON":14,"./Random":17,"check-types":32,"fast.js/array/every":35,"fast.js/forEach":42,"fast.js/object/assign":50}],11:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return m["default"].object(e)&&e.hasOwnProperty(t)}function u(e){a(e);var t=void 0===e._id?!0:e._id,n=s(e),r=function o(e,t){if(m["default"].array(e))return(0,M["default"])(e,function(e){return o(e,t)});var r=n.including?{}:$["default"].clone(e);return(0,b["default"])(t,function(t,u){i(e,u)&&(m["default"].object(t)?(m["default"].object(e[u])||m["default"].array(e[u]))&&(r[u]=o(e[u],t)):n.including?r[u]=$["default"].clone(e[u]):delete r[u])}),r};return function(e){var o=r(e,n.tree);return t&&i(e,"_id")&&(o._id=e._id),!t&&i(o,"_id")&&delete o._id,o}}function a(e){if(!m["default"].object(e)||m["default"].array(e))throw Error("fields option must be an object");(0,b["default"])(e,function(e,t){var n=m["default"].object(e)&&(0,j["default"])(e)||[];if((0,I["default"])(t.split("."),"$")>=0)throw Error("Minimongo doesn't support $ operator in projections yet.");if("object"===("undefined"==typeof e?"undefined":p(e))&&((0,I["default"])(n,"$elemMatch")>=0||(0,I["default"])(n,"$meta")>=0||(0,I["default"])(n,"$slice")>=0))throw Error("Minimongo doesn't support operators in projections yet.");if(-1===(0,I["default"])([1,0,!0,!1],e))throw Error("Projection values should be one of 1, 0, true, or false")})}function s(e){var t=(0,j["default"])(e).sort();!(t.length>0)||1===t.length&&"_id"===t[0]||(0,I["default"])(t,"_id")>=0&&e._id||(t=(0,k["default"])(t,function(e){return"_id"!==e}));var n=null;(0,b["default"])(t,function(t){var r=!!e[t];if(null===n&&(n=r),n!==r)throw Error("You cannot currently mix including and excluding fields.")});var r=f(t,function(e){return n},function(e,t,n){var r=n,o=t;throw Error("both "+r+" and "+o+" found in fields option, using both of them may trigger unexpected behavior. Did you mean to use only one of them?")});return{tree:r,including:n}}function f(e,t,n,r){return r=r||{},(0,b["default"])(e,function(e){var o=r,u=e.split("."),a=(0,S["default"])(u.slice(0,-1),function(t,r){if(i(o,t)){if(!m["default"].object(o[t])&&(o[t]=n(o[t],u.slice(0,r+1).join("."),e),!m["default"].object(o[t])))return!1}else o[t]={};return o=o[t],!0});if(a){var s=u[u.length-1];i(o,s)?o[s]=n(o[s],e,e):o[s]=t(e)}}),r}function c(e,t){var n=s(t),r=n.tree,o={};if(r=f(e,function(e){return!0},function(e,t,n){return!0},r),o=R(r),n.including)return o;var i={};return(0,b["default"])(o,function(e,t){e||(i[t]=!1)}),i}function l(e,t){var n=D(e._getPaths());return(0,I["default"])(n,"")>=0?{}:c(n,t)}function d(e,t){var n=D(e._getPaths());return c(n,t)}var h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},p="function"==typeof Symbol&&"symbol"===h(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":h(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":h(e)},y=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.compileProjection=u,n.checkSupportedProjection=a,n.projectionDetails=s,n.pathsToTree=f,n.combineImportantPathsIntoProjection=c,n.combineMatcherWithProjection=l,n.combineSorterWithProjection=d;var v=e("check-types"),m=r(v),g=e("fast.js/forEach"),b=r(g),_=e("fast.js/object/keys"),j=r(_),w=e("fast.js/object/assign"),O=r(w),E=e("fast.js/array/every"),S=r(E),P=e("fast.js/array/filter"),k=r(P),x=e("fast.js/map"),M=r(x),A=e("fast.js/array/indexOf"),I=r(A),C=e("./EJSON"),$=r(C),N=e("./Document"),T=function(){function e(t){o(this,e),this.fields=t,this._projector=u(t)}return y(e,[{key:"project",value:function(e){var t=this;return m["default"].array(e)?(0,M["default"])(e,function(e){return t._projector(e)}):this._projector(e)}}]),e}();n["default"]=T;var D=function(e){return(0,M["default"])(e,function(e){return(0,k["default"])(e.split("."),function(e){return!(0,N.isNumericKey)(e)}).join(".")})},R=function J(e,t){t=t||"";var n={};return(0,b["default"])(e,function(e,r){m["default"].object(e)?(0,O["default"])(n,J(e,t+r+".")):n[t+r]=e}),n}},{"./Document":8,"./EJSON":14,"check-types":32,"fast.js/array/every":35,"fast.js/array/filter":36,"fast.js/array/indexOf":38,"fast.js/forEach":42,"fast.js/map":49,"fast.js/object/assign":50,"fast.js/object/keys":52}],12:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.DocumentRetriver=void 0;var u=e("check-types"),a=r(u),s=e("fast.js/map"),f=r(s),c=e("fast.js/array/filter"),l=r(c),d=e("./Document"),h=function(){return!0},p=n.DocumentRetriver=function(){function e(t){o(this,e),this.db=t}return i(e,[{key:"retriveForQeury",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?h:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],r=void 0;return(0,d.selectorIsId)(e)?r=[e]:(0,d.selectorIsIdPerhapsAsObject)(e)?r=[e._id]:a["default"].object(e)&&e.hasOwnProperty("_id")&&a["default"].object(e._id)&&e._id.hasOwnProperty("$in")&&a["default"].array(e._id.$in)&&(r=e._id.$in),a["default"].array(r)&&r.length>0?this.retriveIds(t,r,n):this.retriveAll(t,n)}},{key:"retriveAll",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?h:arguments[0],n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=n.limit||+(1/0),o=[],i=!1;return new Promise(function(n,u){var a=e.db.storage.createReadStream();a.on("data",function(u){if(!i&&u.value){var s=e.db.create(u.value);o.length<r&&t(s)&&o.push(s),o.length===r&&a.pause&&(a.pause(),n(o),i=!0)}}).on("end",function(){return!i&&n(o)})})}},{key:"retriveIds",value:function(){var e=arguments.length<=0||void 0===arguments[0]?h:arguments[0],t=this,n=arguments.length<=1||void 0===arguments[1]?[]:arguments[1],r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=(0,l["default"])(n,function(e,t){return n.indexOf(e)===t}),i=(0,f["default"])(o,function(e){return t.retriveOne(e)}),u=r.limit||+(1/0);return Promise.all(i).then(function(t){for(var n=[],r=0;r<t.length;r++){var o=t[r];if(o&&e(o)&&(n.push(o),n.length===u))break}return n})}},{key:"retriveOne",value:function(e){var t=this;return this.db.storage.get(e).then(function(e){return t.db.create(e)})}}]),e}();n["default"]=p},{"./Document":8,"check-types":32,"fast.js/array/filter":36,"fast.js/map":49}],13:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u="function"==typeof Symbol&&"symbol"===i(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":i(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":i(e)},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.DocumentSorter=void 0;var s=e("check-types"),f=r(s),c=e("fast.js/forEach"),l=r(c),d=e("fast.js/array/every"),h=r(d),p=e("fast.js/map"),y=r(p),v=e("fast.js/array/indexOf"),m=r(v),g=e("fast.js/object/keys"),b=r(g),_=e("./DocumentMatcher"),j=r(_),w=e("./Document"),O=n.DocumentSorter=function(){function e(t){var n=this,r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];o(this,e),this._sortSpecParts=[];var i=function(e,t){if(!e)throw Error("sort keys must be non-empty");if("$"===e.charAt(0))throw Error("unsupported sort key: "+e);n._sortSpecParts.push({path:e,lookup:(0,_.makeLookupFunction)(e,{forSort:!0}),ascending:t})};if(t instanceof Array)for(var a=0;a<t.length;a++)"string"==typeof t[a]?i(t[a],!0):i(t[a][0],"desc"!==t[a][1]);else{if("object"!==("undefined"==typeof t?"undefined":u(t)))throw Error("Bad sort specification: "+JSON.stringify(t));(0,l["default"])(t,function(e,t){i(t,e>=0)})}if(this.affectedByModifier){var s={};(0,l["default"])(this._sortSpecParts,function(e){s[e.path]=1}),this._selectorForAffectedByModifier=new j["default"](s)}this._keyComparator=E((0,y["default"])(this._sortSpecParts,function(e,t){return n._keyFieldComparator(t)})),this._keyFilter=null,r.matcher&&this._useWithMatcher(r.matcher)}return a(e,[{key:"getComparator",value:function(e){if(!e||!e.distances)return this._getBaseComparator();var t=e.distances;return E([this._getBaseComparator(),function(e,n){if(!t.has(e._id))throw Error("Missing distance for "+e._id);if(!t.has(n._id))throw Error("Missing distance for "+n._id);return t.get(e._id)-t.get(n._id)}])}},{key:"_getPaths",value:function(){return(0,y["default"])(this._sortSpecParts,function(e){return e.path})}},{key:"_getMinKeyFromDoc",value:function(e){var t=this,n=null;if(this._generateKeysFromDoc(e,function(e){return t._keyCompatibleWithSelector(e)?null===n?void(n=e):void(t._compareKeys(e,n)<0&&(n=e)):void 0}),null===n)throw Error("sort selector found no keys in doc?");return n}},{key:"_keyCompatibleWithSelector",value:function(e){return!this._keyFilter||this._keyFilter(e)}},{key:"_generateKeysFromDoc",value:function(e,t){if(0===this._sortSpecParts.length)throw new Error("can't generate keys without a spec");var n=[],r=function(e){return e.join(",")+","},o=null;if((0,l["default"])(this._sortSpecParts,function(t,i){var u=(0,_.expandArraysInBranches)(t.lookup(e),!0);u.length||(u=[{value:null}]);var a=!1;if(n[i]={},(0,l["default"])(u,function(e){if(!e.arrayIndices){if(u.length>1)throw Error("multiple branches but no array used?");return void(n[i][""]=e.value)}a=!0;var t=r(e.arrayIndices);if(n[i].hasOwnProperty(t))throw Error("duplicate path: "+t);if(n[i][t]=e.value,o&&!o.hasOwnProperty(t))throw Error("cannot index parallel arrays")}),o){if(!n[i].hasOwnProperty("")&&(0,b["default"])(o).length!==(0,b["default"])(n[i]).length)throw Error("cannot index parallel arrays!")}else a&&(o={},(0,l["default"])(n[i],function(e,t){o[t]=!0}))}),!o){var i=(0,y["default"])(n,function(e){if(!e.hasOwnProperty(""))throw Error("no value in sole key case?");return e[""]});return void t(i)}(0,l["default"])(o,function(e,r){var o=(0,y["default"])(n,function(e){if(e.hasOwnProperty(""))return e[""];if(!e.hasOwnProperty(r))throw Error("missing path?");return e[r]});t(o)})}},{key:"_compareKeys",value:function(e,t){if(e.length!==this._sortSpecParts.length||t.length!==this._sortSpecParts.length)throw Error("Key has wrong length");return this._keyComparator(e,t)}},{key:"_keyFieldComparator",value:function(e){var t=!this._sortSpecParts[e].ascending;return function(n,r){var o=w.MongoTypeComp._cmp(n[e],r[e]);return t&&(o=-o),o}}},{key:"_getBaseComparator",value:function(){var e=this;return this._sortSpecParts.length?function(t,n){var r=e._getMinKeyFromDoc(t),o=e._getMinKeyFromDoc(n);return e._compareKeys(r,o)}:function(e,t){return 0}}},{key:"_useWithMatcher",value:function(e){if(this._keyFilter)throw Error("called _useWithMatcher twice?");if(!f["default"].emptyArray(this._sortSpecParts)){var t=e._selector;if(!(t instanceof Function)&&t){var n={};(0,l["default"])(this._sortSpecParts,function(e,t){n[e.path]=[]}),(0,l["default"])(t,function(e,t){var r=n[t];if(r){if(e instanceof RegExp){if(e.ignoreCase||e.multiline)return;return void r.push((0,_.regexpElementMatcher)(e))}return(0,w.isOperatorObject)(e)?void(0,l["default"])(e,function(t,n){(0,m["default"])(["$lt","$lte","$gt","$gte"],n)>=0&&r.push(_.ELEMENT_OPERATORS[n].compileElementSelector(t)),"$regex"!==n||e.$options||r.push(_.ELEMENT_OPERATORS.$regex.compileElementSelector(t,e))}):void r.push((0,_.equalityElementMatcher)(e))}});var r=n[this._sortSpecParts[0].path];f["default"].assigned(r)&&!f["default"].emptyArray(r)&&(this._keyFilter=function(e){return(0,h["default"])(this._sortSpecParts,function(t,r){return(0,h["default"])(n[t.path],function(t){return t(e[r])})})})}}}}]),e}();n["default"]=O;var E=function(e){return function(t,n){for(var r=0;r<e.length;++r){var o=e[r](t,n);if(0!==o)return o}return 0}}},{"./Document":8,"./DocumentMatcher":9,"check-types":32,"fast.js/array/every":35,"fast.js/array/indexOf":38,"fast.js/forEach":42,"fast.js/map":49,"fast.js/object/keys":52}],14:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return"number"==typeof e&&e!=+e}function u(e,t){return m["default"].object(e)&&e.hasOwnProperty(t)}function a(e){return i(e)||e===1/0||e===-(1/0)}function s(e){return!!e&&"object"==("undefined"==typeof e?"undefined":l(e))&&Object.prototype.hasOwnProperty.call(e,"callee")&&!Object.prototype.propertyIsEnumerable.call(e,"callee")}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l="function"==typeof Symbol&&"symbol"===f(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":f(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":f(e)};Object.defineProperty(n,"__esModule",{value:!0}),n.EJSON=void 0;var d=e("./Base64"),h=r(d),p=e("fast.js/array/some"),y=r(p),v=e("check-types"),m=r(v),g=e("fast.js/object/keys"),b=r(g),_=e("fast.js/forEach"),j=r(_),w=n.EJSON=function(){function e(){o(this,e),this._setupBuiltinConverters(),this._customTypes={}}return c(e,[{key:"addType",value:function(e,t){if(u(this._customTypes,e))throw new Error("Type "+e+" already present");this._customTypes[e]=t}},{key:"toJSONValue",value:function(e){var t=this._toJSONValueHelper(e);
return void 0!==t?t:("object"===("undefined"==typeof e?"undefined":l(e))&&(e=this.clone(e),this._adjustTypesToJSONValue(e)),e)}},{key:"fromJSONValue",value:function(e){var t=this._fromJSONValueHelper(e);return t===e&&"object"===("undefined"==typeof e?"undefined":l(e))?(e=this.clone(e),this._adjustTypesFromJSONValue(e),e):t}},{key:"stringify",value:function(e){var t=this.toJSONValue(e);return JSON.stringify(t)}},{key:"parse",value:function(e){if("string"!=typeof e)throw new Error("EJSON.parse argument should be a string");return this.fromJSONValue(JSON.parse(e))}},{key:"isBinary",value:function(e){return!!("undefined"!=typeof Uint8Array&&e instanceof Uint8Array||e&&e.$Uint8ArrayPolyfill)}},{key:"equals",value:function(e,t,n){var r,o=this,a=!(!n||!n.keyOrderSensitive);if(e===t)return!0;if(i(e)&&i(t))return!0;if(!e||!t)return!1;if("object"!==("undefined"==typeof e?"undefined":l(e))||"object"!==("undefined"==typeof t?"undefined":l(t)))return!1;if(e instanceof Date&&t instanceof Date)return e.valueOf()===t.valueOf();if(this.isBinary(e)&&this.isBinary(t)){if(e.length!==t.length)return!1;for(r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}if("function"==typeof e.equals)return e.equals(t,n);if("function"==typeof t.equals)return t.equals(e,n);if(e instanceof Array){if(!(t instanceof Array))return!1;if(e.length!==t.length)return!1;for(r=0;r<e.length;r++)if(!this.equals(e[r],t[r],n))return!1;return!0}switch(this._isCustomType(e)+this._isCustomType(t)){case 1:return!1;case 2:return this.equals(this.toJSONValue(e),this.toJSONValue(t))}var s;if(a){var f=(0,b["default"])(t);return r=0,s=(0,b["default"])(e).every(function(i){return r>=f.length?!1:i!==f[r]?!1:o.equals(e[i],t[f[r]],n)?(r++,!0):!1}),s&&r===f.length}return r=0,s=(0,b["default"])(e).every(function(i){return u(t,i)&&o.equals(e[i],t[i],n)?(r++,!0):!1}),s&&(0,b["default"])(t).length===r}},{key:"clone",value:function(e){var t,n=this;if("object"!==("undefined"==typeof e?"undefined":l(e)))return e;if(null===e)return null;if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return e;if(this.isBinary(e)){t=h["default"].newBinary(e.length);for(var r=0;r<e.length;r++)t[r]=e[r];return t}if(m["default"].array(e)||s(e)){t=[];for(var r=0;r<e.length;r++)t[r]=this.clone(e[r]);return t}return"function"==typeof e.clone?e.clone():this._isCustomType(e)?this.fromJSONValue(this.clone(this.toJSONValue(e)),!0):(t={},(0,j["default"])(e,function(e,r){t[r]=n.clone(e)}),t)}},{key:"newBinary",value:function(e){return h["default"].newBinary(e)}},{key:"_setupBuiltinConverters",value:function(){var e=this;this._builtinConverters=[{matchJSONValue:function(e){return u(e,"$date")&&1===(0,b["default"])(e).length},matchObject:function(e){return e instanceof Date},toJSONValue:function(e){return{$date:e.getTime()}},fromJSONValue:function(e){return new Date(e.$date)}},{matchJSONValue:function(e){return u(e,"$InfNaN")&&1===(0,b["default"])(e).length},matchObject:a,toJSONValue:function(e){var t;return t=i(e)?0:e===1/0?1:-1,{$InfNaN:t}},fromJSONValue:function(e){return e.$InfNaN/0}},{matchJSONValue:function(e){return u(e,"$binary")&&1===(0,b["default"])(e).length},matchObject:function(e){return"undefined"!=typeof Uint8Array&&e instanceof Uint8Array||e&&u(e,"$Uint8ArrayPolyfill")},toJSONValue:function(e){return{$binary:h["default"].encode(e)}},fromJSONValue:function(e){return h["default"].decode(e.$binary)}},{matchJSONValue:function(e){return u(e,"$escape")&&1===(0,b["default"])(e).length},matchObject:function(t){return!m["default"].assigned(t)||m["default"].emptyObject(t)||m["default"].object(t)&&(0,b["default"])(t).length>2?!1:(0,y["default"])(e._builtinConverters,function(e){return e.matchJSONValue(t)})},toJSONValue:function(t){var n={};return(0,j["default"])(t,function(t,r){n[r]=e.toJSONValue(t)}),{$escape:n}},fromJSONValue:function(t){var n={};return(0,j["default"])(t.$escape,function(t,r){n[r]=e.fromJSONValue(t)}),n}},{matchJSONValue:function(e){return u(e,"$type")&&u(e,"$value")&&2===(0,b["default"])(e).length},matchObject:function(t){return e._isCustomType(t)},toJSONValue:function(e){var t=e.toJSONValue();return{$type:e.typeName(),$value:t}},fromJSONValue:function(t){var n=t.$type;if(!u(e._customTypes,n))throw new Error("Custom EJSON type "+n+" is not defined");var r=e._customTypes[n];return r(t.$value)}}]}},{key:"_isCustomType",value:function(e){return e&&"function"==typeof e.toJSONValue&&"function"==typeof e.typeName&&u(this._customTypes,e.typeName())}},{key:"_adjustTypesToJSONValue",value:function(e){var t=this;if(null===e)return null;var n=this._toJSONValueHelper(e);return void 0!==n?n:"object"!==("undefined"==typeof e?"undefined":l(e))?e:((0,j["default"])(e,function(n,r){if("object"===("undefined"==typeof n?"undefined":l(n))||void 0===n||a(n)){var o=t._toJSONValueHelper(n);return o?void(e[r]=o):void t._adjustTypesToJSONValue(n)}}),e)}},{key:"_toJSONValueHelper",value:function(e){for(var t=0;t<this._builtinConverters.length;t++){var n=this._builtinConverters[t];if(n.matchObject(e))return n.toJSONValue(e)}}},{key:"_adjustTypesFromJSONValue",value:function(e){var t=this;if(null===e)return null;var n=this._fromJSONValueHelper(e);return n!==e?n:"object"!==("undefined"==typeof e?"undefined":l(e))?e:((0,j["default"])(e,function(n,r){if("object"===("undefined"==typeof n?"undefined":l(n))){var o=t._fromJSONValueHelper(n);if(n!==o)return void(e[r]=o);t._adjustTypesFromJSONValue(n)}}),e)}},{key:"_fromJSONValueHelper",value:function(e){if("object"===("undefined"==typeof e?"undefined":l(e))&&null!==e&&(0,b["default"])(e).length<=2&&(0,b["default"])(e).every(function(e){return"string"==typeof e&&"$"===e.substr(0,1)}))for(var t=0;t<this._builtinConverters.length;t++){var n=this._builtinConverters[t];if(n.matchJSONValue(e))return n.fromJSONValue(e)}return e}}]),e}();n["default"]=new w},{"./Base64":2,"check-types":32,"fast.js/array/some":41,"fast.js/forEach":42,"fast.js/object/keys":52}],15:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.IndexManager=void 0;var u=e("fast.js/function/bind"),a=r(u),s=e("fast.js/object/keys"),f=r(s),c=e("fast.js/forEach"),l=r(c),d=e("fast.js/map"),h=r(d),p=e("invariant"),y=r(p),v=e("./PromiseQueue"),m=r(v),g=e("./CollectionIndex"),b=r(g),_=e("./DocumentRetriver"),j=r(_),w=n.IndexManager=function(){function e(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];o(this,e),this.db=t,this.indexes={},this._queue=new m["default"](n.concurrency||2),this.ensureIndex({fieldName:"_id",unique:!0})}return i(e,[{key:"ensureIndex",value:function(e){(0,y["default"])(e&&e.fieldName,"You must specify a fieldName in options object");var t=e.fieldName;return this.indexes[t]?this.indexes[t].buildPromise?this.indexes[t].buildPromise:e&&e.forceRebuild?this.buildIndex(t):Promise.resolve():(this.indexes[t]=new b["default"](e),this.buildIndex(t))}},{key:"buildIndex",value:function(e){var t=this;(0,y["default"])(this.indexes[e],"Index with key `%s` does not ensured yet",e);var n=function(){return t.indexes[e].buildPromise=null},r=this._queue.add((0,a["default"])(this._doBuildIndex,this,e)).then(n,n);return this.indexes[e].buildPromise=r,r}},{key:"buildAllIndexes",value:function(){var e=this;return Promise.all((0,h["default"])(this.indexes,function(t,n){return e.ensureIndex({fieldName:n,forceRebuild:!0})}))}},{key:"removeIndex",value:function(e){var t=this;return this._queue.add(function(){delete t.indexes[e]})}},{key:"indexDocument",value:function(e){var t=this;return this._queue.add(function(){var n=(0,f["default"])(t.indexes),r=null;try{(0,l["default"])(n,function(n,o){r=o,t.indexes[n].insert(e)})}catch(o){throw(0,l["default"])(n.slice(0,r),function(n){t.indexes[n].remove(e)}),o}})}},{key:"reindexDocument",value:function(e,t){var n=this;return this._queue.add(function(){var r=(0,f["default"])(n.indexes),o=null;try{(0,l["default"])(r,function(r,i){o=i,n.indexes[r].update(e,t)})}catch(i){throw(0,l["default"])(r.slice(0,o),function(r){n.indexes[r].revertUpdate(e,t)}),i}})}},{key:"deindexDocument",value:function(e){var t=this;return this._queue.add(function(){var n=(0,f["default"])(t.indexes);(0,l["default"])(n,function(n){t.indexes[n].remove(e)})})}},{key:"_doBuildIndex",value:function(e){var t=this.indexes[e];t.reset();var n=[];return new j["default"](this.db).retriveAll().then(function(e){if((0,l["default"])(e,function(e){try{t.insert(e)}catch(r){n.push([r,e])}}),n.length>0)throw new Error("Index build failed with errors: ",n)})}}]),e}();n["default"]=w},{"./CollectionIndex":5,"./DocumentRetriver":12,"./PromiseQueue":16,"fast.js/forEach":42,"fast.js/function/bind":45,"fast.js/map":49,"fast.js/object/keys":52,invariant:56}],16:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0});var u=e("fast.js/function/try"),a=r(u),s=e("double-ended-queue"),f=r(s),c=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?1/0:arguments[0],n=arguments.length<=1||void 0===arguments[1]?1/0:arguments[1];o(this,e),this.pendingPromises=0,this.maxPendingPromises=t,this.maxQueuedPromises=n,this.queue=new f["default"],this.length=0}return i(e,[{key:"pause",value:function(){this._paused=!0}},{key:"unpause",value:function(){this._paused=!1,this._dequeue()}},{key:"add",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return new Promise(function(r,o){if(t.length>=t.maxQueuedPromises)o(new Error("Queue limit reached"));else{var i={promiseGenerator:e,resolve:r,reject:o};n?t.queue.unshift(i):t.queue.push(i),t.length+=1,t._dequeue()}})}},{key:"_dequeue",value:function(){var e=this;if(this._paused||this.pendingPromises>=this.maxPendingPromises)return!1;var t=this.queue.shift();if(!t)return!1;var n=(0,a["default"])(function(){return e.pendingPromises++,Promise.resolve().then(function(){return t.promiseGenerator()}).then(function(n){e.length--,e.pendingPromises--,t.resolve(n),e._dequeue()},function(n){e.length--,e.pendingPromises--,t.reject(n),e._dequeue()})});return n instanceof Error&&(this.length--,this.pendingPromises--,t.reject(n),this._dequeue()),!0}}]),e}();n["default"]=c},{"double-ended-queue":33,"fast.js/function/try":48}],17:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(){var e="undefined"!=typeof window&&window.innerHeight||"undefined"!=typeof document&&document.documentElement&&document.documentElement.clientHeight||"undefined"!=typeof document&&document.body&&document.body.clientHeight||1,t="undefined"!=typeof window&&window.innerWidth||"undefined"!=typeof document&&document.documentElement&&document.documentElement.clientWidth||"undefined"!=typeof document&&document.body&&document.body.clientWidth||1,n="undefined"!=typeof navigator&&navigator.userAgent||"";return[new Date,e,t,n,Math.random()]}var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},a="function"==typeof Symbol&&"symbol"===u(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":u(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":u(e)},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n._getBrowserSeeds=i;var f=e("fast.js/function/try"),c=r(f),l=e("invariant"),d=r(l),h=void 0,p={NODE_CRYPTO:"NODE_CRYPTO",BROWSER_CRYPTO:"BROWSER_CRYPTO",ALEA:"ALEA"},y="23456789ABCDEFGHJKLMNPQRSTWXYZabcdefghijkmnopqrstuvwxyz",v="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_",m=function(){function e(){var e=4022871197,t=function(t){t=t.toString();for(var n=0;n<t.length;n++){e+=t.charCodeAt(n);var r=.02519603282416938*e;e=r>>>0,r-=e,r*=e,e=r>>>0,r-=e,e+=4294967296*r}return 2.3283064365386963e-10*(e>>>0)};return t.version="Mash 0.9",t}return function(t){var n=0,r=0,o=0,i=1;0==t.length&&(t=[+new Date]);var u=e();n=u(" "),r=u(" "),o=u(" ");for(var a=0;a<t.length;a++)n-=u(t[a]),0>n&&(n+=1),r-=u(t[a]),0>r&&(r+=1),o-=u(t[a]),0>o&&(o+=1);u=null;var s=function(){var e=2091639*n+2.3283064365386963e-10*i;return n=r,r=o,o=e-(i=0|e)};return s.uint32=function(){return 4294967296*s()},s.fract53=function(){return s()+1.1102230246251565e-16*(2097152*s()|0)},s.version="Alea 0.9",s.args=t,s}(Array.prototype.slice.call(arguments))},g=function(){function t(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];o(this,t),this.type=e,(0,d["default"])(p[e],"Random(...): no generator type %s",e),e===p.ALEA&&((0,d["default"])(n.seeds,"Random(...): seed is not provided for ALEA seeded generator"),this.alea=m.apply(null,n.seeds))}return s(t,[{key:"fraction",value:function(){if(this.type===p.ALEA)return this.alea();if(this.type===p.NODE_CRYPTO){var e=parseInt(this.hexString(8),16);return 2.3283064365386963e-10*e}if(this.type===p.BROWSER_CRYPTO){var t=new Uint32Array(1);return window.crypto.getRandomValues(t),2.3283064365386963e-10*t[0]}throw new Error("Unknown random generator type: "+this.type)}},{key:"hexString",value:function(t){if(this.type!==p.NODE_CRYPTO)return this._randomString(t,"0123456789abcdef");var n=function(){var n=e("crypto"),r=Math.ceil(t/2),o=(0,c["default"])(function(){return n.randomBytes(r)});o instanceof Error&&(o=n.pseudoRandomBytes(r));var i=o.toString("hex");return{v:i.substring(0,t)}}();return"object"===("undefined"==typeof n?"undefined":a(n))?n.v:void 0}},{key:"_randomString",value:function(e,t){for(var n=[],r=0;e>r;r++)n[r]=this.choice(t);return n.join("")}},{key:"id",value:function(e){return void 0===e&&(e=17),this._randomString(e,y)}},{key:"secret",value:function(e){return void 0===e&&(e=43),this._randomString(e,v)}},{key:"choice",value:function(e){var t=Math.floor(this.fraction()*e.length);return"string"==typeof e?e.substr(t,1):e[t]}}],[{key:"default",value:function(){return h?h:"undefined"!=typeof window?window.crypto&&window.crypto.getRandomValues?new t(p.BROWSER_CRYPTO):new t(p.ALEA,{seeds:i()}):new t(p.NODE_CRYPTO)}},{key:"createWithSeeds",value:function(){return(0,d["default"])(arguments.length,"Random.createWithSeeds(...): no seeds were provided"),new t(p.ALEA,{seeds:arguments})}}]),t}();n["default"]=g},{crypto:void 0,"fast.js/function/try":48,invariant:56}],18:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n["default"]=function(e){var t=i["default"]["default"]().hexString(20),n=[t,"/collection/"+e];return{value:i["default"].createWithSeeds.apply(null,n).id(17),seed:t}};var o=e("./Random"),i=r(o)},{"./Random":17}],19:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();Object.defineProperty(n,"__esModule",{value:!0}),n.StorageManager=void 0;var u=e("fast.js/object/keys"),a=r(u),s=e("eventemitter3"),f=r(s),c=e("./PromiseQueue"),l=r(c),d=e("./EJSON"),h=r(d),p=n.StorageManager=function(){function e(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];o(this,e),this.db=t,this.options=n,this._queue=new l["default"](1),this._storage={},this.reload()}return i(e,[{key:"loaded",value:function(){return this._loadedPromise}},{key:"reload",value:function(){var e=this;return this._loadedPromise?this._loadedPromise=this._loadedPromise.then(function(){return e._loadStorage()}):this._loadedPromise=this._loadStorage(),this.loaded()}},{key:"destroy",value:function(){var e=this;return this.loaded().then(function(){e._storage={}})}},{key:"persist",value:function(e,t){var n=this;return this.loaded().then(function(){n._storage[e]=h["default"].clone(t)})}},{key:"delete",value:function(e){var t=this;return this.loaded().then(function(){delete t._storage[e]})}},{key:"get",value:function(e){var t=this;return this.loaded().then(function(){return t._storage[e]})}},{key:"createReadStream",value:function(){var e=this,t=(arguments.length<=0||void 0===arguments[0]?{}:arguments[0],!1),n=new f["default"];return n.pause=function(){return t=!0},this.loaded().then(function(){for(var r=(0,a["default"])(e._storage),o=0;o<r.length;o++)if(n.emit("data",{value:e._storage[r[o]]}),t)return;n.emit("end")}),n}},{key:"_loadStorage",value:function(){return this._storage={},Promise.resolve()}}]),e}();n["default"]=p},{"./EJSON":14,"./PromiseQueue":16,eventemitter3:34,"fast.js/object/keys":52}],20:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.aggregate=void 0;var o=e("invariant"),i=r(o);n.aggregate={method:function(e){return(0,i["default"])("function"==typeof e,"aggregate(...): aggregator must be a function"),this._addPipeline("aggregate",e),this},process:function(e,t){return t.value(e)}}},{invariant:56}],21:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.filter=void 0;var o=e("invariant"),i=r(o),u=e("fast.js/array/filter"),a=r(u);n.filter={method:function(e){return(0,i["default"])("function"==typeof e,"filter(...): argument must be a function"),this._addPipeline("filter",e),this},process:function(e,t){return(0,a["default"])(e,t.value)}}},{"fast.js/array/filter":36,invariant:56}],22:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.ifNotEmpty=void 0;var o=e("check-types"),i=r(o);n.ifNotEmpty={method:function(){return this._addPipeline("ifNotEmpty"),this},process:function(e){var t=!i["default"].assigned(e)||i["default"].array(e)&&i["default"].emptyArray(e)||i["default"].object(e)&&i["default"].emptyObject(e);return t?"___[STOP]___":e}}},{"check-types":32}],23:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.join=void 0;var o=e("check-types"),i=r(o),u=e("invariant"),a=r(u),s=e("./joinObj"),f=e("./joinEach"),c=e("./joinAll");n.join={method:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return(0,a["default"])("function"==typeof e||i["default"].object(e),"join(...): argument must be a function"),this._addPipeline("join",e,t),this},process:function(e,t,n){return i["default"].object(t.value)?s.joinObj.process(e,t,n):i["default"].array(e)?f.joinEach.process(e,t,n):c.joinAll.process(e,t,n)}}},{"./joinAll":24,"./joinEach":25,"./joinObj":26,"check-types":32,invariant:56}],24:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.joinAll=void 0;var o=e("check-types"),i=r(o),u=e("fast.js/map"),a=r(u),s=e("fast.js/function/bind"),f=r(s),c=e("invariant"),l=r(c);n.joinAll={method:function(e){return(0,l["default"])("function"==typeof e,"joinAll(...): argument must be a function"),this._addPipeline("joinAll",e),this},process:function(e,t,n){var r=arguments.length<=3||void 0===arguments[3]?0:arguments[3],o=arguments.length<=4||void 0===arguments[4]?1:arguments[4],u=n._propagateUpdate?(0,f["default"])(n._propagateUpdate,n):function(){},s=t.value(e,u,r,o);return s=i["default"].array(s)?s:[s],s=(0,a["default"])(s,function(e){var t=void 0;return e&&e.joinAll?t=e.exec():i["default"].object(e)&&e.cursor&&e.then&&(t=e),t&&n._trackChildCursorPromise(t),t||e}),Promise.all(s).then(function(){return e})}}},{"check-types":32,"fast.js/function/bind":45,"fast.js/map":49,invariant:56}],25:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":o(e)};Object.defineProperty(n,"__esModule",{value:!0}),n.joinEach=void 0;var u=e("check-types"),a=r(u),s=e("fast.js/map"),f=r(s),c=e("invariant"),l=r(c),d=e("./joinAll");n.joinEach={method:function(e){return(0,l["default"])("function"==typeof e,"joinEach(...): argument must be a function"),this._addPipeline("joinEach",e),this},process:function(e,t,n){if(!e)return Promise.resolve(e);var r=function(){e=a["default"].array(e)?e:[e];var r=e.length;return{v:Promise.all((0,f["default"])(e,function(e,o){return d.joinAll.process(e,t,n,o,r)}))}}();return"object"===("undefined"==typeof r?"undefined":i(r))?r.v:void 0}}},{"./joinAll":24,"check-types":32,"fast.js/map":49,invariant:56}],26:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){var n=(0,M.makeLookupFunction)(t),r=[],i=(0,v["default"])(e,function(e){var t=n(e),i=(0,g["default"])((0,_["default"])((0,v["default"])(t,function(e){return e.value}),function(e,t){return d["default"].array(t)?[].concat(o(e),o(t)):[].concat(o(e),[t])},[]),function(e){return(0,A.selectorIsId)(e)});return r=r.concat(i),{doc:e,lookupResult:t}});return{allIds:r,docsWrapped:i}}function u(e,t){if(t instanceof E["default"])return{model:t,joinPath:e};if(d["default"].object(t))return{model:t.model,joinPath:t.joinPath||e};throw new Error("Invalid join object value")}function a(e,t,n){var r={},o=e.split(".");(0,p["default"])(t,function(e){return r[e._id]=e}),(0,p["default"])(n,function(e){(0,p["default"])(e.lookupResult,function(t){if(t.value){var n=o.slice(),i=(0,x.findModTarget)(e.doc,n,{noCreate:!1,forbidArray:!1,arrayIndices:t.arrayIndices}),u=n[n.length-1];d["default"].array(t.value)?i[u]=(0,v["default"])(t.value,function(e){return r[e]}):i[u]=r[t.value]||null}})})}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},f="function"==typeof Symbol&&"symbol"===s(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":s(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":"undefined"==typeof e?"undefined":s(e)},c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};Object.defineProperty(n,"__esModule",{value:!0}),n.joinObj=void 0;var l=e("check-types"),d=r(l),h=e("fast.js/forEach"),p=r(h),y=e("fast.js/map"),v=r(y),m=e("fast.js/array/filter"),g=r(m),b=e("fast.js/array/reduce"),_=r(b),j=e("fast.js/object/keys"),w=r(j),O=e("../Collection"),E=r(O),S=e("invariant"),P=r(S),k=e("./joinAll"),x=e("../DocumentModifier"),M=e("../DocumentMatcher"),A=e("../Document");n.joinObj={method:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return(0,P["default"])(d["default"].object(e),"joinObj(...): argument must be an object"),this._addPipeline("joinObj",e,t),this},process:function(e,t,n){if(!e)return Promise.resolve(e);var r=function(){var r=t.value,o=t.args[0]||{},s=!d["default"].array(e);e=s?[e]:e;var f=function(t){return(0,v["default"])((0,w["default"])(r),function(t){var n=u(t,r[t]),s=n.model,f=n.joinPath,c=i(e,t),l=c.allIds,d=c.docsWrapped,h=o.observe?"observe":"then";return s.find({_id:{$in:l}})[h](function(e){a(f,e,d)})})},l=c({},t,{value:f});return{v:k.joinAll.process(e,l,n).then(function(e){return s?e[0]:e})}}();return"object"===("undefined"==typeof r?"undefined":f(r))?r.v:void 0}}},{"../Collection":3,"../Document":8,"../DocumentMatcher":9,"../DocumentModifier":10,"./joinAll":24,"check-types":32,"fast.js/array/filter":36,"fast.js/array/reduce":40,"fast.js/forEach":42,"fast.js/map":49,"fast.js/object/keys":52,invariant:56}],27:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.map=void 0;var o=e("fast.js/map"),i=r(o),u=e("invariant"),a=r(u);n.map={method:function(e){return(0,a["default"])("function"==typeof e,"map(...): mapper must be a function"),this._addPipeline("map",e),this},process:function(e,t){return(0,i["default"])(e,t.value)}}},{"fast.js/map":49,invariant:56}],28:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.reduce=void 0;var o=e("fast.js/array/reduce"),i=r(o),u=e("invariant"),a=r(u);n.reduce={method:function(e,t){return(0,a["default"])("function"==typeof e,"reduce(...): reducer argument must be a function"),this._addPipeline("reduce",e,t),this},process:function(e,t){return(0,i["default"])(e,t.value,t.args[0])}}},{"fast.js/array/reduce":40,invariant:56}],29:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0}),n.sortFunc=void 0;var o=e("invariant"),i=r(o);n.sortFunc={method:function(e){return(0,i["default"])("function"==typeof e,"sortFunc(...): argument must be a function"),this._addPipeline("sortFunc",e),this},process:function(e,t){return e.sort(t.value)}}},{invariant:56}],30:[function(e,t,n){"use strict";function r(e,t,n){var r=null,o=0,i=null,u=!0,a=null,s=function(){var s=this,f=arguments;if(i){var c=n&&o>=n;if(u=!c,c&&a){var l=i;return l.debouncePassed=!0,clearTimeout(r),a(),o+=1,l}}else i=new Promise(function(n,c){(a=function(){u?(r=setTimeout(a,t),u=!1):(n(e.apply(s,f)),i=null,o=0,r=null,u=!0,a=null)})()});return o+=1,i},f=function(e){n=e},c=function(e){t=e},l=function(){clearTimeout(r)};return s.updateBatchSize=f,s.updateWait=c,s.cancel=l,s.func=e,s}Object.defineProperty(n,"__esModule",{value:!0}),n["default"]=r},{}],31:[function(e,t,n){"use strict";var r=e("./dist/AsyncEventEmitter")["default"],o=e("./dist/Collection")["default"],i=e("./dist/CursorObservable")["default"],u=e("./dist/debounce")["default"],a=e("./dist/StorageManager")["default"],s=e("./dist/Random")["default"],f=e("./dist/EJSON")["default"],c=e("./dist/Base64")["default"],l=e("./dist/PromiseQueue")["default"];t.exports={__esModule:!0,"default":o,Random:s,EJSON:f,Base64:c,Collection:o,CursorObservable:i,StorageManager:a,EventEmitter:r,PromiseQueue:l,debounce:u}},{"./dist/AsyncEventEmitter":1,"./dist/Base64":2,"./dist/Collection":3,"./dist/CursorObservable":7,"./dist/EJSON":14,"./dist/PromiseQueue":16,"./dist/Random":17,"./dist/StorageManager":19,"./dist/debounce":30}],32:[function(t,n,r){!function(t){"use strict";function r(e,t){return e===t}function o(e){return void 0===e}function i(e){return null===e}function u(e){return!o(e)&&!i(e)}function a(e){return 0===e}function s(e){return e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY}function f(e){return"number"==typeof e&&isNaN(e)===!1&&e!==Number.POSITIVE_INFINITY&&e!==Number.NEGATIVE_INFINITY}function c(e){return f(e)&&e%1===0}function l(e){return f(e)&&e%2===0}function d(e){return c(e)&&!l(e)}function h(e,t){return f(e)&&e>t}function p(e,t){return f(e)&&t>e}function y(e,t,n){return n>t?h(e,t)&&p(e,n):p(e,t)&&h(e,n)}function v(e,t){return f(e)&&e>=t}function m(e,t){return f(e)&&t>=e}function g(e,t,n){return n>t?v(e,t)&&m(e,n):m(e,t)&&v(e,n)}function b(e){return h(e,0)}function _(e){return p(e,0)}function j(e){return"string"==typeof e}function w(e){return""===e}function O(e){return j(e)&&""!==e}function E(e,t){return j(e)&&-1!==e.indexOf(t)}function S(e,t){return j(e)&&!!e.match(t)}function P(e){return e===!1||e===!0}function k(e){return"[object Object]"===Object.prototype.toString.call(e)}function x(e){return k(e)&&0===Object.keys(e).length}function M(e,t){try{return e instanceof t}catch(n){return!1}}function A(e,t){try{return M(e,t)||Object.prototype.toString.call(e)==="[object "+t.name+"]"}catch(n){return!1}}function I(e,t){try{return M(e,t)||e.constructor.name===t.name}catch(n){return!1}}function C(e,t){var n;for(n in t)if(t.hasOwnProperty(n)){if(e.hasOwnProperty(n)===!1||typeof e[n]!=typeof t[n])return!1;if(k(e[n])&&C(e[n],t[n])===!1)return!1}return!0}function $(e){return Array.isArray(e)}function N(e){return $(e)&&0===e.length}function T(e){return u(e)&&f(e.length)}function D(e){return"undefined"==typeof Symbol?T(e):u(e)&&B(e[Symbol.iterator])}function R(e,t){var n,r;if(me.assigned(e))return!1;try{if("undefined"!=typeof Symbol&&e[Symbol.iterator]&&B(e.values)){n=e.values();do if(r=n.next(),r.value===t)return!0;while(!r.done);return!1}Object.keys(e).forEach(function(n){if(e[n]===t)throw 0})}catch(o){return!0}return!1}function J(e,t){return u(e)&&e.length===t}function q(e){return A(e,Date)&&!isNaN(e.getTime())}function B(e){return"function"==typeof e}function V(e,t){return ve.array(e),B(t)?e.map(function(e){return t(e)}):(ve.array(t),ve.hasLength(e,t.length),e.map(function(e,n){return t[n](e)}))}function U(e,t){return ve.object(e),B(t)?L(e,t):(ve.object(t),F(e,t))}function L(e,t){var n={};return Object.keys(e).forEach(function(r){n[r]=t(e[r])}),n}function F(e,t){var n={};return Object.keys(t).forEach(function(r){var o=t[r];B(o)?me.assigned(e)?n[r]=!!o._isMaybefied:n[r]=o(e[r]):k(o)&&(n[r]=F(e[r],o))}),n}function W(e){return $(e)?z(e,!1):(ve.object(e),Q(e,!1))}function z(e,t){var n;for(n=0;n<e.length;n+=1)if(e[n]===t)return t;return!t}function Q(e,t){var n,r;for(n in e)if(e.hasOwnProperty(n)){if(r=e[n],k(r)&&Q(r,t)===t)return t;if(r===t)return t}return!t}function G(e){return $(e)?z(e,!0):(ve.object(e),Q(e,!0))}function Y(e,t){return Object.keys(t).forEach(function(n){e[n]=t[n]}),e}function K(e,t){return function(){H(e,arguments,t)}}function H(e,t,n){var r=t[t.length-1];X(e.apply(null,t),O(r)?r:n)}function X(e,t){if(e===!1)throw new Error(t||"Assertion failed")}function Z(e){return function(){return ee(e.apply(null,arguments))}}function ee(e){return!e}function te(e){var t=function(){return me.assigned(arguments[0])?!0:e.apply(null,arguments)};return t._isMaybefied=!0,t}function ne(e){return u(e)===!1?!0:e}function re(e,t,n){return function(){var r,o;if(r=arguments[0],"maybe"===e&&me.assigned(r))return!0;if(!t(r))return!1;r=oe(t,r),o=_e.call(arguments,1);try{r.forEach(function(t){if(("maybe"!==e||u(t))&&!n.apply(null,[t].concat(o)))throw 0})}catch(i){return!1}return!0}}function oe(e,t){switch(e){case T:return _e.call(t);case k:return Object.keys(t).map(function(e){return t[e]});default:return t}}function ie(e,t){return ue([e,pe,t])}function ue(e){var t,n,r,o;return t=e.shift(),n=e.pop(),r=e.pop(),o=n||{},Object.keys(r).forEach(function(n){Object.defineProperty(o,n,{configurable:!1,enumerable:!0,writable:!1,value:t.apply(null,e.concat(r[n],he[n]))})}),o}function ae(e,t){return ue([e,t,null])}function se(e){pe[e].of=ue([re.bind(null,null),pe[e],pe,null]);
}function fe(e,t){be.forEach(function(n){e[n].of=ae(t,pe[n].of)})}function ce(e){ge[e].of=ue([re.bind(null,"maybe"),pe[e],pe,null]),ve.maybe[e].of=ae(K,ge[e].of),ve.not[e].of=ae(K,me[e].of)}function le(r){"function"==typeof e&&e.amd?e(function(){return r}):"undefined"!=typeof n&&null!==n&&n.exports?n.exports=r:t.check=r}var de,he,pe,ye,ve,me,ge,be,_e;de={v:"value",n:"number",s:"string",b:"boolean",o:"object",t:"type",a:"array",al:"array-like",i:"iterable",d:"date",f:"function",l:"length"},he={},pe={},[{n:"equal",f:r,s:"v"},{n:"undefined",f:o,s:"v"},{n:"null",f:i,s:"v"},{n:"assigned",f:u,s:"v"},{n:"includes",f:R,s:"v"},{n:"zero",f:a,s:"n"},{n:"infinity",f:s,s:"n"},{n:"number",f:f,s:"n"},{n:"integer",f:c,s:"n"},{n:"even",f:l,s:"n"},{n:"odd",f:d,s:"n"},{n:"greater",f:h,s:"n"},{n:"less",f:p,s:"n"},{n:"between",f:y,s:"n"},{n:"greaterOrEqual",f:v,s:"n"},{n:"lessOrEqual",f:m,s:"n"},{n:"inRange",f:g,s:"n"},{n:"positive",f:b,s:"n"},{n:"negative",f:_,s:"n"},{n:"string",f:j,s:"s"},{n:"emptyString",f:w,s:"s"},{n:"nonEmptyString",f:O,s:"s"},{n:"contains",f:E,s:"s"},{n:"match",f:S,s:"s"},{n:"boolean",f:P,s:"b"},{n:"object",f:k,s:"o"},{n:"emptyObject",f:x,s:"o"},{n:"instance",f:M,s:"t"},{n:"builtIn",f:A,s:"t"},{n:"userDefined",f:I,s:"t"},{n:"like",f:C,s:"t"},{n:"array",f:$,s:"a"},{n:"emptyArray",f:N,s:"a"},{n:"arrayLike",f:T,s:"al"},{n:"iterable",f:D,s:"i"},{n:"date",f:q,s:"d"},{n:"function",f:B,s:"f"},{n:"hasLength",f:J,s:"l"}].map(function(e){he[e.n]="Invalid "+de[e.s],pe[e.n]=e.f}),ye={apply:V,map:U,all:W,any:G},be=["array","arrayLike","iterable","object"],_e=Array.prototype.slice,ye=Y(ye,pe),ve=ie(K,X),me=ie(Z,ee),ge=ie(te,ne),ve.not=ae(K,me),ve.maybe=ae(K,ge),be.forEach(se),fe(ve,K),fe(me,Z),be.forEach(ce),le(Y(ye,{assert:ve,not:me,maybe:ge}))}(this)},{}],33:[function(e,t,n){"use strict";function r(e){if(this._capacity=u(e),this._length=0,this._front=0,this._makeCapacity(),a(e)){for(var t=e.length,n=0;t>n;++n)this[n]=e[n];this._length=t}}function o(e,t,n,r,o){for(var i=0;o>i;++i)n[i+r]=e[i+t]}function i(e){return e>>>=0,e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e+1}function u(e){if("number"!=typeof e){if(!a(e))return 16;e=e.length}return i(Math.min(Math.max(16,e),1073741824))}r.prototype.toArray=function(){for(var e=this._length,t=new Array(e),n=this._front,r=this._capacity,o=0;e>o;++o)t[o]=this[n+o&r-1];return t},r.prototype.push=function(e){var t=arguments.length,n=this._length;if(t>1){var r=this._capacity;if(n+t>r){for(var o=0;t>o;++o){this._checkCapacity(n+1);var i=this._front+n&this._capacity-1;this[i]=arguments[o],n++,this._length=n}return n}for(var i=this._front,o=0;t>o;++o)this[i+n&r-1]=arguments[o],i++;return this._length=n+t,n+t}if(0===t)return n;this._checkCapacity(n+1);var o=this._front+n&this._capacity-1;return this[o]=e,this._length=n+1,n+1},r.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,n=this[t];return this[t]=void 0,this._length=e-1,n}},r.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,n=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,n}},r.prototype.unshift=function(e){var t=this._length,n=arguments.length;if(n>1){var r=this._capacity;if(t+n>r){for(var o=n-1;o>=0;o--){this._checkCapacity(t+1);var r=this._capacity,i=(this._front-1&r-1^r)-r;this[i]=arguments[o],t++,this._length=t,this._front=i}return t}for(var u=this._front,o=n-1;o>=0;o--){var i=(u-1&r-1^r)-r;this[i]=arguments[o],u=i}return this._front=u,this._length=t+n,t+n}if(0===n)return t;this._checkCapacity(t+1);var r=this._capacity,o=(this._front-1&r-1^r)-r;return this[o]=e,this._length=t+1,this._front=o,t+1},r.prototype.peekBack=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1;return this[t]}},r.prototype.peekFront=function(){return 0!==this._length?this[this._front]:void 0},r.prototype.get=function(e){var t=e;if(t===(0|t)){var n=this._length;if(0>t&&(t+=n),!(0>t||t>=n))return this[this._front+t&this._capacity-1]}},r.prototype.isEmpty=function(){return 0===this._length},r.prototype.clear=function(){this._length=0,this._front=0,this._makeCapacity()},r.prototype.toString=function(){return this.toArray().toString()},r.prototype.valueOf=r.prototype.toString,r.prototype.removeFront=r.prototype.shift,r.prototype.removeBack=r.prototype.pop,r.prototype.insertFront=r.prototype.unshift,r.prototype.insertBack=r.prototype.push,r.prototype.enqueue=r.prototype.push,r.prototype.dequeue=r.prototype.shift,r.prototype.toJSON=r.prototype.toArray,Object.defineProperty(r.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),r.prototype._makeCapacity=function(){for(var e=this._capacity,t=0;e>t;++t)this[t]=void 0},r.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(u(1.5*this._capacity+16))},r.prototype._resizeTo=function(e){var t=this._front,n=this._capacity,r=new Array(n),i=this._length;if(o(this,0,r,0,n),this._capacity=e,this._makeCapacity(),this._front=0,n>=t+i)o(r,t,this,0,i);else{var u=i-(t+i&n-1);o(r,t,this,0,u),o(r,0,this,u,i-u)}};var a=Array.isArray;t.exports=r},{}],34:[function(e,t,n){"use strict";function r(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(){}var i="function"!=typeof Object.create?"~":!1;o.prototype._events=void 0,o.prototype.listeners=function(e,t){var n=i?i+e:e,r=this._events&&this._events[n];if(t)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var o=0,u=r.length,a=new Array(u);u>o;o++)a[o]=r[o].fn;return a},o.prototype.emit=function(e,t,n,r,o,u){var a=i?i+e:e;if(!this._events||!this._events[a])return!1;var s,f,c=this._events[a],l=arguments.length;if("function"==typeof c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,r),!0;case 5:return c.fn.call(c.context,t,n,r,o),!0;case 6:return c.fn.call(c.context,t,n,r,o,u),!0}for(f=1,s=new Array(l-1);l>f;f++)s[f-1]=arguments[f];c.fn.apply(c.context,s)}else{var d,h=c.length;for(f=0;h>f;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;default:if(!s)for(d=1,s=new Array(l-1);l>d;d++)s[d-1]=arguments[d];c[f].fn.apply(c[f].context,s)}}return!0},o.prototype.on=function(e,t,n){var o=new r(t,n||this),u=i?i+e:e;return this._events||(this._events=i?{}:Object.create(null)),this._events[u]?this._events[u].fn?this._events[u]=[this._events[u],o]:this._events[u].push(o):this._events[u]=o,this},o.prototype.once=function(e,t,n){var o=new r(t,n||this,!0),u=i?i+e:e;return this._events||(this._events=i?{}:Object.create(null)),this._events[u]?this._events[u].fn?this._events[u]=[this._events[u],o]:this._events[u].push(o):this._events[u]=o,this},o.prototype.removeListener=function(e,t,n,r){var o=i?i+e:e;if(!this._events||!this._events[o])return this;var u=this._events[o],a=[];if(t)if(u.fn)(u.fn!==t||r&&!u.once||n&&u.context!==n)&&a.push(u);else for(var s=0,f=u.length;f>s;s++)(u[s].fn!==t||r&&!u[s].once||n&&u[s].context!==n)&&a.push(u[s]);return a.length?this._events[o]=1===a.length?a[0]:a:delete this._events[o],this},o.prototype.removeAllListeners=function(e){return this._events?(e?delete this._events[i?i+e:e]:this._events=i?{}:Object.create(null),this):this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prototype.setMaxListeners=function(){return this},o.prefixed=i,"undefined"!=typeof t&&(t.exports=o)},{}],35:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i=e.length,u=void 0!==n?r(t,n):t;for(o=0;i>o;o++)if(!u(e[o],o,e))return!1;return!0}},{"../function/bindInternal3":46}],36:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i=e.length,u=[],a=void 0!==n?r(t,n):t;for(o=0;i>o;o++)a(e[o],o,e)&&u.push(e[o]);return u}},{"../function/bindInternal3":46}],37:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i=e.length,u=void 0!==n?r(t,n):t;for(o=0;i>o;o++)u(e[o],o,e)}},{"../function/bindInternal3":46}],38:[function(e,t,n){"use strict";t.exports=function(e,t,n){var r=e.length,o=0;for("number"==typeof n&&(o=n,0>o&&(o+=r,0>o&&(o=0)));r>o;o++)if(e[o]===t)return o;return-1}},{}],39:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i=e.length,u=new Array(i),a=void 0!==n?r(t,n):t;for(o=0;i>o;o++)u[o]=a(e[o],o,e);return u}},{"../function/bindInternal3":46}],40:[function(e,t,n){"use strict";var r=e("../function/bindInternal4");t.exports=function(e,t,n,o){var i,u,a=e.length,s=void 0!==o?r(t,o):t;for(void 0===n?(i=1,u=e[0]):(i=0,u=n);a>i;i++)u=s(u,e[i],i,e);return u}},{"../function/bindInternal4":47}],41:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i=e.length,u=void 0!==n?r(t,n):t;for(o=0;i>o;o++)if(u(e[o],o,e))return!0;return!1}},{"../function/bindInternal3":46}],42:[function(e,t,n){"use strict";var r=e("./array/forEach"),o=e("./object/forEach");t.exports=function(e,t,n){return e instanceof Array?r(e,t,n):o(e,t,n)}},{"./array/forEach":37,"./object/forEach":51}],43:[function(e,t,n){"use strict";t.exports=function(e,t){switch(t.length){case 0:return e();case 1:return e(t[0]);case 2:return e(t[0],t[1]);case 3:return e(t[0],t[1],t[2]);case 4:return e(t[0],t[1],t[2],t[3]);case 5:return e(t[0],t[1],t[2],t[3],t[4]);case 6:return e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6]);case 8:return e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]);default:return e.apply(void 0,t)}}},{}],44:[function(e,t,n){"use strict";t.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2]);case 4:return e.call(t,n[0],n[1],n[2],n[3]);case 5:return e.call(t,n[0],n[1],n[2],n[3],n[4]);case 6:return e.call(t,n[0],n[1],n[2],n[3],n[4],n[5]);case 7:return e.call(t,n[0],n[1],n[2],n[3],n[4],n[5],n[6]);case 8:return e.call(t,n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]);default:return e.apply(t,n)}}},{}],45:[function(e,t,n){"use strict";var r=e("./applyWithContext"),o=e("./applyNoContext");t.exports=function(e,t){var n,i=arguments.length-2;if(i>0){n=new Array(i);for(var u=0;i>u;u++)n[u]=arguments[u+2];return void 0!==t?function(){var o,u=arguments.length,a=new Array(i+u);for(o=0;i>o;o++)a[o]=n[o];for(o=0;u>o;o++)a[i+o]=arguments[o];return r(e,t,a)}:function(){var t,r=arguments.length,u=new Array(i+r);for(t=0;i>t;t++)u[t]=n[t];for(t=0;r>t;t++)u[i+t]=arguments[t];return o(e,u)}}return void 0!==t?function(){return r(e,t,arguments)}:function(){return o(e,arguments)}}},{"./applyNoContext":43,"./applyWithContext":44}],46:[function(e,t,n){"use strict";t.exports=function(e,t){return function(n,r,o){return e.call(t,n,r,o)}}},{}],47:[function(e,t,n){"use strict";t.exports=function(e,t){return function(n,r,o,i){return e.call(t,n,r,o,i)}}},{}],48:[function(e,t,n){"use strict";t.exports=function(e){try{return e()}catch(t){return t instanceof Error?t:new Error(t)}}},{}],49:[function(e,t,n){"use strict";var r=e("./array/map"),o=e("./object/map");t.exports=function(e,t,n){return e instanceof Array?r(e,t,n):o(e,t,n)}},{"./array/map":39,"./object/map":53}],50:[function(e,t,n){"use strict";t.exports=function(e){var t,n,r,o,i,u,a=arguments.length;for(n=1;a>n;n++)for(t=arguments[n],o=Object.keys(t),r=o.length,u=0;r>u;u++)i=o[u],e[i]=t[i];return e}},{}],51:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i,u=Object.keys(e),a=u.length,s=void 0!==n?r(t,n):t;for(i=0;a>i;i++)o=u[i],s(e[o],o,e)}},{"../function/bindInternal3":46}],52:[function(e,t,n){"use strict";t.exports="function"==typeof Object.keys?Object.keys:function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},{}],53:[function(e,t,n){"use strict";var r=e("../function/bindInternal3");t.exports=function(e,t,n){var o,i,u=Object.keys(e),a=u.length,s={},f=void 0!==n?r(t,n):t;for(o=0;a>o;o++)i=u[o],s[i]=f(e[i],i,e);return s}},{"../function/bindInternal3":46}],54:[function(e,t,n){"use strict";t.exports=function(e){for(var t=Object.keys(e),n=t.length,r=new Array(n),o=0;n>o;o++)r[o]=e[t[o]];return r}},{}],55:[function(e,t,n){!function(){function e(e){for(var t=[],n=[],r=0;r<e[0].length;r++)t.push(e[0][r][1]),n.push(e[0][r][0]);return t=t.sort(function(e,t){return e-t}),n=n.sort(function(e,t){return e-t}),[[t[0],n[0]],[t[t.length-1],n[n.length-1]]]}function n(e,t,n){for(var r=[[0,0]],o=0;o<n.length;o++){for(var i=0;i<n[o].length;i++)r.push(n[o][i]);r.push(n[o][0]),r.push([0,0])}for(var u=!1,o=0,i=r.length-1;o<r.length;i=o++)r[o][0]>t!=r[i][0]>t&&e<(r[i][1]-r[o][1])*(t-r[o][0])/(r[i][0]-r[o][0])+r[o][1]&&(u=!u);return u}var r=this.gju={};"undefined"!=typeof t&&t.exports&&(t.exports=r),r.lineStringsIntersect=function(e,t){for(var n=[],r=0;r<=e.coordinates.length-2;++r)for(var o=0;o<=t.coordinates.length-2;++o){var i={x:e.coordinates[r][1],y:e.coordinates[r][0]},u={x:e.coordinates[r+1][1],y:e.coordinates[r+1][0]},a={x:t.coordinates[o][1],y:t.coordinates[o][0]},s={x:t.coordinates[o+1][1],y:t.coordinates[o+1][0]},f=(s.x-a.x)*(i.y-a.y)-(s.y-a.y)*(i.x-a.x),c=(u.x-i.x)*(i.y-a.y)-(u.y-i.y)*(i.x-a.x),l=(s.y-a.y)*(u.x-i.x)-(s.x-a.x)*(u.y-i.y);if(0!=l){var d=f/l,h=c/l;d>=0&&1>=d&&h>=0&&1>=h&&n.push({type:"Point",coordinates:[i.x+d*(u.x-i.x),i.y+d*(u.y-i.y)]})}}return 0==n.length&&(n=!1),n},r.pointInBoundingBox=function(e,t){return!(e.coordinates[1]<t[0][0]||e.coordinates[1]>t[1][0]||e.coordinates[0]<t[0][1]||e.coordinates[0]>t[1][1])},r.pointInPolygon=function(t,o){for(var i="Polygon"==o.type?[o.coordinates]:o.coordinates,u=!1,a=0;a<i.length;a++)r.pointInBoundingBox(t,e(i[a]))&&(u=!0);if(!u)return!1;for(var s=!1,a=0;a<i.length;a++)n(t.coordinates[1],t.coordinates[0],i[a])&&(s=!0);return s},r.pointInMultiPolygon=function(t,o){for(var i="MultiPolygon"==o.type?[o.coordinates]:o.coordinates,u=!1,a=!1,s=0;s<i.length;s++){for(var f=i[s],c=0;c<f.length;c++)u||r.pointInBoundingBox(t,e(f[c]))&&(u=!0);if(!u)return!1;for(var c=0;c<f.length;c++)a||n(t.coordinates[1],t.coordinates[0],f[c])&&(a=!0)}return a},r.numberToRadius=function(e){return e*Math.PI/180},r.numberToDegree=function(e){return 180*e/Math.PI},r.drawCircle=function(e,t,n){for(var o=[t.coordinates[1],t.coordinates[0]],i=e/1e3/6371,u=[r.numberToRadius(o[0]),r.numberToRadius(o[1])],n=n||15,a=[[o[0],o[1]]],s=0;n>s;s++){var f=2*Math.PI*s/n,c=Math.asin(Math.sin(u[0])*Math.cos(i)+Math.cos(u[0])*Math.sin(i)*Math.cos(f)),l=u[1]+Math.atan2(Math.sin(f)*Math.sin(i)*Math.cos(u[0]),Math.cos(i)-Math.sin(u[0])*Math.sin(c));a[s]=[],a[s][1]=r.numberToDegree(c),a[s][0]=r.numberToDegree(l)}return{type:"Polygon",coordinates:[a]}},r.rectangleCentroid=function(e){var t=e.coordinates[0],n=t[0][0],r=t[0][1],o=t[2][0],i=t[2][1],u=o-n,a=i-r;return{type:"Point",coordinates:[n+u/2,r+a/2]}},r.pointDistance=function(e,t){var n=e.coordinates[0],o=e.coordinates[1],i=t.coordinates[0],u=t.coordinates[1],a=r.numberToRadius(u-o),s=r.numberToRadius(i-n),f=Math.pow(Math.sin(a/2),2)+Math.cos(r.numberToRadius(o))*Math.cos(r.numberToRadius(u))*Math.pow(Math.sin(s/2),2),c=2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f));return 6371*c*1e3},r.geometryWithinRadius=function(e,t,n){if("Point"==e.type)return r.pointDistance(e,t)<=n;if("LineString"==e.type||"Polygon"==e.type){var o,i={};o="Polygon"==e.type?e.coordinates[0]:e.coordinates;for(var u in o)if(i.coordinates=o[u],r.pointDistance(i,t)>n)return!1}return!0},r.area=function(e){for(var t,n,r=0,o=e.coordinates[0],i=o.length-1,u=0;u<o.length;i=u++){var t={x:o[u][1],y:o[u][0]},n={x:o[i][1],y:o[i][0]};r+=t.x*n.y,r-=t.y*n.x}return r/=2},r.centroid=function(e){for(var t,n,o,i=0,u=0,a=e.coordinates[0],s=a.length-1,f=0;f<a.length;s=f++){var n={x:a[f][1],y:a[f][0]},o={x:a[s][1],y:a[s][0]};t=n.x*o.y-o.x*n.y,i+=(n.x+o.x)*t,u+=(n.y+o.y)*t}return t=6*r.area(e),{type:"Point",coordinates:[u/t,i/t]}},r.simplify=function(e,t){t=t||20,e=e.map(function(e){return{lng:e.coordinates[0],lat:e.coordinates[1]}});var n,r,o,i,u,a,s,f,c,l,d,h,p,y,v,m,g,b,_,j=Math.PI/180*.5,w=new Array,O=new Array,E=new Array;if(e.length<3)return e;for(n=e.length,l=360*t/(2*Math.PI*6378137),l*=l,o=0,O[0]=0,E[0]=n-1,r=1;r>0;)if(i=O[r-1],u=E[r-1],r--,u-i>1){for(d=e[u].lng()-e[i].lng(),h=e[u].lat()-e[i].lat(),Math.abs(d)>180&&(d=360-Math.abs(d)),d*=Math.cos(j*(e[u].lat()+e[i].lat())),p=d*d+h*h,a=i+1,s=i,c=-1;u>a;a++)y=e[a].lng()-e[i].lng(),v=e[a].lat()-e[i].lat(),Math.abs(y)>180&&(y=360-Math.abs(y)),y*=Math.cos(j*(e[a].lat()+e[i].lat())),m=y*y+v*v,g=e[a].lng()-e[u].lng(),b=e[a].lat()-e[u].lat(),Math.abs(g)>180&&(g=360-Math.abs(g)),g*=Math.cos(j*(e[a].lat()+e[u].lat())),_=g*g+b*b,f=m>=p+_?_:_>=p+m?m:(y*h-v*d)*(y*h-v*d)/p,f>c&&(s=a,c=f);l>c?(w[o]=i,o++):(r++,O[r-1]=s,E[r-1]=u,r++,O[r-1]=i,E[r-1]=s)}else w[o]=i,o++;w[o]=n-1,o++;for(var S=new Array,a=0;o>a;a++)S.push(e[w[a]]);return S.map(function(e){return{type:"Point",coordinates:[e.lng,e.lat]}})},r.destinationPoint=function(e,t,n){n/=6371,t=r.numberToRadius(t);var o=r.numberToRadius(e.coordinates[0]),i=r.numberToRadius(e.coordinates[1]),u=Math.asin(Math.sin(i)*Math.cos(n)+Math.cos(i)*Math.sin(n)*Math.cos(t)),a=o+Math.atan2(Math.sin(t)*Math.sin(n)*Math.cos(i),Math.cos(n)-Math.sin(i)*Math.sin(u));return a=(a+3*Math.PI)%(2*Math.PI)-Math.PI,{type:"Point",coordinates:[r.numberToDegree(a),r.numberToDegree(u)]}}}()},{}],56:[function(e,t,n){"use strict";var r=function(e,t,n,r,o,i,u,a){if(!e){var s;if(void 0===t)s=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var f=[n,r,o,i,u,a],c=0;s=new Error(t.replace(/%s/g,function(){return f[c++]})),s.name="Invariant Violation"}throw s.framesToPop=1,s}};t.exports=r},{}]},{},[31])(31)});